# Pipeline: OpenAI Usage Extraction
# Domain: Usage
# Action: Extract (API -> Raw BQ)

pipeline_id: "openai-usage-extract"
name: "OpenAI Usage Extraction"
description: "Fetch organization usage data from OpenAI API"
version: "1.0.0"

schedule:
  type: daily
  time: "02:00"
  timezone: UTC

variables:
  org_slug: "{org_slug}"

steps:
  # Extract Completions Usage
  - step_id: "fetch_completions"
    ps_type: "generic.api_extractor"
    description: "Fetch completions usage"
    config:
      url: "https://api.openai.com/v1/organization/usage/completions"
      method: "GET"
      auth:
        type: "bearer"
        secret_key: "openai_api_key"
      params:
        start_time: "{start_ts}"
        end_time: "{end_ts}"
        bucket_width: "1d"
        group_by: "model,project_id"
        limit: 100
      pagination:
        type: "cursor"
        param: "after"
        response_path: "meta.next_cursor"
      destination:
        table: "openai_usage_completions_raw"

  # Extract Embeddings Usage
  - step_id: "fetch_embeddings"
    ps_type: "generic.api_extractor"
    description: "Fetch embeddings usage"
    config:
      url: "https://api.openai.com/v1/organization/usage/embeddings"
      method: "GET"
      auth:
        type: "bearer"
        secret_key: "openai_api_key"
      params:
        start_time: "{start_ts}"
        end_time: "{end_ts}"
        bucket_width: "1d"
        group_by: "model,project_id"
        limit: 100
      pagination:
        type: "cursor"
        param: "after"
        response_path: "meta.next_cursor"
      destination:
        table: "openai_usage_embeddings_raw"

requires_auth: true
auth_type: "org_api_key"

tags:
  - openai
  - usage
  - extract
category: "usage"
