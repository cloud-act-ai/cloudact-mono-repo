# OpenAI Usage & Cost Pipeline
# Extracts usage from OpenAI API, calculates cost, stores in BigQuery
#
# Schedule: Daily at 02:00 UTC
# Tables: openai_usage_daily_raw, openai_cost_daily

pipeline_id: "{org_slug}-openai-usage-cost"
name: "OpenAI Usage & Cost Sync"
description: "Extract usage from OpenAI API, calculate costs, store in BigQuery"
version: "1.0.0"

# Pipeline-level timeout (minutes)
timeout_minutes: 10

# Rate limiting (requests per minute for this pipeline)
rate_limit_per_minute: 60

# Schedule configuration
schedule:
  type: daily
  time: "02:00"
  timezone: UTC

variables:
  org_slug: "{org_slug}"
  provider: "openai"

steps:
  # Step 1: Extract raw usage from OpenAI API
  - step_id: "extract_usage"
    ps_type: "openai.usage"
    description: "Fetch usage data from OpenAI API"
    timeout_minutes: 5
    config:
      start_date: "{start_date}"
      end_date: "{end_date}"
      destination_table: "openai_usage_daily_raw"

  # Step 2: Transform usage to cost (reads from BQ, not API)
  - step_id: "transform_cost"
    ps_type: "openai.cost"
    depends_on: "extract_usage"
    description: "Calculate cost from usage data using model pricing"
    timeout_minutes: 3
    config:
      source_table: "openai_usage_daily_raw"
      destination_table: "openai_cost_daily"
      pricing_table: "openai_model_pricing"

requires_auth: true
auth_type: "org_api_key"

tags:
  - usage
  - cost
  - openai
  - llm
  - daily
category: "llm_analytics"
