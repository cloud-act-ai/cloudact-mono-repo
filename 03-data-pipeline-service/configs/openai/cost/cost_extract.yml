# Pipeline: OpenAI Cost Extraction
# Domain: Finance
# Action: Extract (API -> Raw BQ)

pipeline_id: "openai-cost-extract"
name: "OpenAI Cost Extraction"
description: "Fetch organization cost data from OpenAI API"
version: "1.0.0"

schedule:
  type: daily
  time: "02:30"
  timezone: UTC

variables:
  org_slug: "{org_slug}"

steps:
  - step_id: "fetch_costs"
    ps_type: "generic.api_extractor"
    description: "Fetch daily costs breakdown"
    config:
      url: "https://api.openai.com/v1/organization/costs"
      method: "GET"
      auth:
        type: "bearer"
        secret_key: "openai_api_key"
      params:
        start_time: "{start_ts}"
        end_time: "{end_ts}"
        bucket_width: "1d"
        group_by: "line_item,project_id"
        limit: 100
      pagination:
        type: "cursor"
        param: "after"
        response_path: "meta.next_cursor"
      destination:
        table: "openai_cost_raw"

requires_auth: true
auth_type: "org_api_key"

tags:
  - openai
  - cost
  - extract
category: "finance"
