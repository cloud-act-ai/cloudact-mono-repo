# SaaS Subscription Costs Pipeline
# Calculates daily amortized costs from subscription plans and converts to FOCUS 1.3 format
#
# Schedule: Daily at 03:00 UTC (after other cost pipelines)
# Tables: subscription_plan_costs_daily, cost_data_standard_1_3
#
# Flow:
#   0. Query MIN(effective_date) from active plans (auto start date detection)
#   1. Read active subscriptions from subscription_plans
#   2. Calculate daily amortized costs (sp_subscription_2_calculate_daily_costs)
#   3. Convert to FOCUS 1.3 standard (sp_subscription_3_convert_to_focus)
#
# FOCUS 1.3 Key Changes:
#   - ServiceProviderName/HostProviderName/InvoiceIssuerName replace deprecated ProviderName/PublisherName
#   - Org-specific extension fields (x_org_slug, x_org_owner_email, x_org_default_currency, etc.)
#   - Tags as JSON instead of REPEATED RECORD
#   - ContractApplied for linking to contract_commitment_1_3
#
# Procedures Location: {project_id}.organizations (central dataset)
# Data Location: {project_id}.{org_slug}_{env} (per-org dataset)
#
# Notifications:
#   Pipeline failures automatically trigger email notifications if configured.
#   To enable notifications, create a notification config file at:
#   - Org-specific: configs/{org_slug}/notifications.json
#   - Or use root config: configs/notifications/config.json
#   See: configs/notifications/README.md for setup instructions

pipeline_id: "{org_slug}-subscription-costs"
name: "SaaS Subscription Costs Pipeline"
description: "Calculate daily amortized SaaS subscription costs and convert to FOCUS 1.3 format"
version: "1.0.0"

# Pipeline-level timeout (minutes)
# Monthly processing can take longer for large subscription datasets
timeout_minutes: 15

# Rate limiting (requests per minute for this pipeline)
rate_limit_per_minute: 30

# Schedule configuration
schedule:
  type: daily
  time: "03:00"
  timezone: UTC

variables:
  org_slug: "{org_slug}"
  provider: "subscription"

steps:
  # BUG-031 FIX: Add validation step before processing
  - step_id: "validate_subscription_data"
    ps_type: "generic.procedure_executor"
    description: "Validate subscription_plans data quality before cost calculation"
    timeout_minutes: 2
    config:
      procedure:
        name: sp_subscription_1_validate_data
        dataset: organizations
      parameters:
        - name: p_project_id
          type: STRING
          value: "${project_id}"
        - name: p_dataset_id
          type: STRING
          value: "${org_dataset}"
    continue_on_failure: false  # Stop pipeline if validation fails

  # Single step that runs the orchestrator procedure
  # The procedure internally calls:
  #   1. sp_subscription_2_calculate_daily_costs (Stage 1)
  #   2. sp_subscription_3_convert_to_focus (Stage 2)
  - step_id: "run_cost_pipeline"
    ps_type: "generic.procedure_executor"
    description: "Execute SaaS subscription cost calculation and FOCUS 1.3 conversion"
    timeout_minutes: 10
    config:
      procedure:
        name: sp_subscription_4_run_pipeline
        dataset: organizations  # Central dataset where procedure lives
      parameters:
        - name: p_project_id
          type: STRING
          value: "${project_id}"
        - name: p_dataset_id
          type: STRING
          value: "${org_dataset}"
        - name: p_start_date
          type: DATE
          value: "${start_date}"
          default: "MONTH_START"  # Default to earliest effective_date from active plans, or month start
        - name: p_end_date
          type: DATE
          value: "${end_date}"
          default: "TODAY"  # Default to current date

requires_auth: true
auth_type: "org_api_key"

# Metadata
tags:
  - subscription
  - cost
  - focus
  - daily
category: "subscription_analytics"

# Integration requirements
# This pipeline requires the organization to have:
# - subscription_plans table with active subscriptions
# - Procedures synced to organizations dataset
integration_required: false  # No external API needed, uses internal data

# Output tables (for documentation)
output_tables:
  - name: subscription_plan_costs_daily
    description: "Daily amortized subscription costs"
    partition_field: cost_date
    cluster_fields:
      - org_slug
      - subscription_id
  - name: cost_data_standard_1_3
    description: "FOCUS 1.3 standardized costs (x_source_system = 'subscription_costs_daily'). Includes org-specific fields."
    partition_field: ChargePeriodStart
    cluster_fields:
      - SubAccountId
      - ServiceProviderName
      - ServiceCategory
