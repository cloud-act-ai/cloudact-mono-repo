# AWS Billing to FOCUS 1.3 Conversion Pipeline
#
# Converts AWS CUR billing data to FOCUS 1.3 standard format
# Schedule: Daily at 6:00 AM UTC (after billing pipeline completes at 5:00 AM)
# URL: POST /api/v1/pipelines/run/{org}/aws/cost/focus_convert
#
# BEHAVIOR:
# - Idempotent: Deletes existing FOCUS data for date range before inserting
# - Runs the sp_cloud_1_convert_to_focus stored procedure with p_provider='aws'
# - Produces records in cost_data_standard_1_3 table
#
# FOCUS 1.3 FIELD MAPPINGS:
# - BilledCost: unblended_cost (gross cost before credits)
# - EffectiveCost: net_unblended_cost (net cost after credits/discounts)
# - ListCost: public_on_demand_cost (full retail price)
# - ConsumedQuantity: usage_amount
# - ConsumedUnit: usage_unit
# - ChargeCategory: Credit for negative costs/credits, Tax for tax items
# - SubAccountId: linked_account_id (member account in AWS Organizations)

pipeline_id: "{org_slug}-aws-focus-convert"
name: "AWS FOCUS 1.3 Conversion"
description: "Convert AWS CUR billing data to FOCUS 1.3 standard format"
provider: "aws"
domain: "cost"
version: "18.0.0"

# Schedule: 6:00 AM UTC daily (after billing pipeline at 5:00 AM)
schedule: "0 6 * * *"

variables:
  org_slug: "{org_slug}"
  provider: "aws"
  domain: "cost"
  # Default date: Yesterday (T-1) - overridden by request parameters
  default_date_offset: "-1"

steps:
  # Step 1: Convert AWS billing data to FOCUS 1.3
  - step_id: "convert_aws_to_focus"
    name: "Convert AWS Costs to FOCUS 1.3"
    ps_type: "generic.bq_procedure"
    description: "Execute stored procedure to convert AWS billing data to FOCUS 1.3"
    config:
      procedure: "sp_cloud_1_convert_to_focus"
      dataset: "organizations"
      parameters:
        - name: "p_project_id"
          type: "STRING"
          value: "{gcp_project_id}"
        - name: "p_dataset_id"
          type: "STRING"
          value: "{org_slug}_{environment}"
        - name: "p_start_date"
          type: "DATE"
          value: "{start_date}"
        - name: "p_end_date"
          type: "DATE"
          value: "{end_date}"
        - name: "p_provider"
          type: "STRING"
          value: "aws"
        - name: "p_pipeline_id"
          type: "STRING"
          value: "{pipeline_id}"
        - name: "p_credential_id"
          type: "STRING"
          value: "{credential_id}"
        - name: "p_run_id"
          type: "STRING"
          value: "{run_id}"
    timeout_minutes: 30
    retry:
      max_attempts: 3
      backoff_seconds: 60
    on_failure: "fail"

  # Step 2: Notification on failure
  - step_id: "notify_on_failure"
    name: "Notify on Failure"
    ps_type: "notify_systems.email_notification"
    description: "Send failure notification"
    trigger: "on_failure"
    config:
      to_emails:
        - "{admin_email}"
        - "data-ops@example.com"
      subject: "[ALERT] AWS FOCUS Conversion Failed - {org_slug}"
      message: |
        ALERT: The AWS FOCUS 1.3 conversion pipeline has failed!

        Organization: {org_slug}
        Pipeline: {pipeline_id}
        Run Date: {date}
        Date Range: {start_date} to {end_date}

requires_auth: true
auth_type: "org_api_key"

tags:
  - focus
  - aws
  - cost
  - conversion
  - daily
category: "cloud_cost"
