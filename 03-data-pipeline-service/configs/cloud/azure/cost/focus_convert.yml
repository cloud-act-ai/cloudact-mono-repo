# Azure Billing to FOCUS 1.3 Conversion Pipeline
# Converts Azure Cost Management data to FOCUS 1.3 standard format
#
# Schedule: Daily at 6:30 AM UTC (after billing pipeline completes)
# Tables: cost_data_standard_1_3
#
# Usage:
#   POST /api/v1/pipelines/run/{org_slug}/azure/cost/focus_convert
#   POST /api/v1/pipelines/run/{org_slug}/azure/cost/focus_convert?start_date=2026-01-01&end_date=2026-01-22
#
# NOTE: This pipeline can be run standalone to re-convert existing raw data to FOCUS 1.3
#       The billing.yml pipeline already includes FOCUS conversion as step 4,
#       so this is mainly for backfill or re-conversion scenarios.
#
# BEHAVIOR:
# - Idempotent: Deletes existing FOCUS records for date range before inserting
# - Uses sp_cloud_1_convert_to_focus stored procedure for consistency
# - Supports date ranges for backfill

pipeline_id: "{org_slug}-azure-focus-convert"
name: "Azure FOCUS 1.3 Conversion"
description: "Convert Azure Cost Management data to FOCUS 1.3 standard (standalone re-conversion)"
provider: "azure"
domain: "cost"
version: "18.0.0"

# Schedule configuration (cron expression: daily at 06:30 UTC)
schedule: "30 6 * * *"

variables:
  org_slug: "{org_slug}"
  provider: "azure"
  # Default date: Yesterday (T-1) - overridden by request parameters
  default_date_offset: "-1"

steps:
  # Step 1: Convert Azure raw billing data to FOCUS 1.3
  - step_id: "convert_azure_to_focus"
    name: "Convert Azure Costs to FOCUS 1.3"
    ps_type: "generic.procedure_executor"
    description: "Execute stored procedure to convert Azure billing data to FOCUS 1.3"
    config:
      procedure:
        name: "sp_cloud_1_convert_to_focus"
        dataset: "organizations"
      parameters:
        - name: "p_project_id"
          type: "STRING"
          value: "${project_id}"
        - name: "p_dataset_id"
          type: "STRING"
          value: "${org_dataset}"
        - name: "p_start_date"
          type: "DATE"
          value: "${start_date}"
        - name: "p_end_date"
          type: "DATE"
          value: "${end_date}"
        - name: "p_provider"
          type: "STRING"
          value: "azure"
        - name: "p_pipeline_id"
          type: "STRING"
          value: "${pipeline_id}"
        - name: "p_credential_id"
          type: "STRING"
          value: "${credential_id}"
        - name: "p_run_id"
          type: "STRING"
          value: "${run_id}"
    timeout_minutes: 30
    retry:
      max_attempts: 3
      backoff_seconds: 60
    on_failure: "stop"

  # Step 2: Notification on failure
  - step_id: "notify_on_failure"
    name: "Notify on Failure"
    ps_type: "notify_systems.email_notification"
    description: "Send failure notification"
    trigger: "on_failure"
    config:
      to_emails:
        - "{admin_email}"
        - "data-ops@example.com"
      subject: "[ALERT] Azure FOCUS Conversion Failed - {org_slug}"
      message: |
        ALERT: The Azure FOCUS 1.3 conversion pipeline has failed!

        Organization: {org_slug}
        Pipeline: {pipeline_id}
        Date Range: {start_date} to {end_date}

requires_auth: true
auth_type: "org_api_key"

tags:
  - focus
  - azure
  - cost
  - conversion
category: "cloud_cost"
