# Azure Billing Pipeline
# Extracts billing data from Azure Cost Management API, stores in BigQuery
#
# Schedule: Daily at 05:00 UTC (processes yesterday's data by default)
# Tables: cloud_azure_billing_raw_daily
#
# Usage:
#   POST /api/v1/pipelines/run/{org_slug}/azure/cost/billing
#   POST /api/v1/pipelines/run/{org_slug}/azure/cost/billing?start_date=2026-01-01&end_date=2026-01-22
#
# BEHAVIOR:
# - Default: Processes yesterday's data (T-1) based on usage_date
# - Idempotent: Deletes existing data for date range before inserting
# - Supports date ranges for backfill
#
# PREREQUISITES:
# 1. Organization must have a valid AZURE integration configured
# 2. Azure Service Principal must have Cost Management Reader access
# 3. billing_scope must be configured in the integration metadata
#    (e.g., /subscriptions/{subscription-id} or /providers/Microsoft.Billing/billingAccounts/{billing-account-id})
#
# AZURE COST MANAGEMENT API:
# - Uses Cost Management Query API for cost data extraction
# - Supports EA, MCA, CSP, and Pay-As-You-Go subscription types
# - Exports ActualCost (billed charges) and AmortizedCost (spread reservations)

pipeline_id: "{org_slug}-azure-billing"
name: "Azure Billing Sync"
description: "Extract Azure billing costs and store in BigQuery (idempotent, replaces existing data)"
provider: "azure"
domain: "cost"
version: "19.0.0"

# Schedule configuration (cron expression: daily at 05:00 UTC)
schedule: "0 5 * * *"

variables:
  org_slug: "{org_slug}"
  provider: "azure"
  # NOTE: billing_scope should be configured per-org via integration settings
  # This comes from the org's Azure integration credentials
  billing_scope: "{billing_scope}"
  # Multi-tenant: Use customer's Azure Service Principal credentials
  use_org_credentials: "true"
  # Default date: Yesterday (T-1) - overridden by request parameters
  default_date_offset: "-1"

steps:
  # Step 1: Decrypt Azure credentials for customer's billing data
  - step_id: "decrypt_credentials"
    name: "Decrypt Credentials"
    ps_type: "integrations.kms_decrypt"
    description: "Load organization Azure credentials"
    enabled: "{use_org_credentials}"
    config:
      provider: "AZURE"
      require_valid: true
      context_key: "azure_credentials_json"
    on_failure: "continue"

  # Step 2: Delete existing data for date range (idempotent - allows re-runs)
  - step_id: "delete_existing_data"
    name: "Delete Existing Data"
    ps_type: "generic.bq_execute"
    description: "Delete existing billing data for date range to ensure idempotency"
    depends_on:
      - "decrypt_credentials"
    config:
      query: |
        DELETE FROM `{gcp_project_id}.{org_slug}_{environment}.cloud_azure_billing_raw_daily`
        WHERE usage_date BETWEEN @start_date AND @end_date
          AND x_org_slug = @org_slug
      parameters:
        - name: "start_date"
          type: "DATE"
          value: "{start_date}"
        - name: "end_date"
          type: "DATE"
          value: "{end_date}"
        - name: "org_slug"
          type: "STRING"
          value: "{org_slug}"
    on_failure: "continue"  # Continue even if table doesn't exist yet

  # Step 3: Extract billing data from Azure Cost Management API
  - step_id: "extract_billing"
    name: "Extract Billing Data"
    ps_type: "cloud.azure.cost_extractor"
    description: "Extract Azure Cost Management data for date range"
    depends_on:
      - "delete_existing_data"
    timeout_minutes: 30

    source:
      # Multi-tenant: Use customer's Azure SP credentials to read their cost data
      use_org_credentials: true
      # Azure Cost Management Query API configuration
      api_version: "2023-11-01"
      export_type: "ActualCost"
      granularity: "Daily"
      # Time period from request parameters
      time_period:
        from: "{start_date}"
        to: "{end_date}"
      # Columns to extract (comprehensive for FOCUS 1.3 conversion)
      columns:
        - SubscriptionId
        - SubscriptionName
        - ResourceGroup
        - ResourceId
        - ResourceName
        - ResourceType
        - ResourceLocation
        - ServiceName
        - ServiceTier
        - ServiceFamily
        - MeterId
        - MeterName
        - MeterCategory
        - MeterSubCategory
        - MeterRegion
        - ProductName
        - ProductOrderId
        - ProductOrderName
        - ConsumedService
        - ChargeType
        - UsageDate
        - BillingPeriodStartDate
        - BillingPeriodEndDate
        - UsageStartTime
        - UsageEndTime
        - UsageQuantity
        - UnitOfMeasure
        - CostInBillingCurrency
        - CostInUsd
        - BillingCurrency
        - ExchangeRate
        - ExchangeRateDate
        - EffectivePrice
        - UnitPrice
        - PayGPrice
        - PricingModel
        - PricingQuantity
        - PricingUnit
        - ReservationId
        - ReservationName
        - SavingsPlanId
        - SavingsPlanName
        - BenefitId
        - BenefitName
        - Frequency
        - Term
        - PublisherType
        - PublisherName
        - InvoiceId
        - InvoiceSectionId
        - InvoiceSectionName
        - BillingAccountId
        - BillingAccountName
        - BillingProfileId
        - BillingProfileName
        - CostCenter
        - IsAzureCreditEligible
        - Tags
        - AdditionalInfo
        - ServiceInfo1
        - ServiceInfo2

    # Destination: Always CloudAct project + org dataset ({org_slug}_{env})
    destination:
      dataset_type: "azure"
      table: "cloud_azure_billing_raw_daily"
      write_mode: "append"
      schema_template: "billing_cost"
      table_config:
        time_partitioning:
          field: "x_ingestion_date"
          type: "DAY"
          expiration_days: 730
        clustering_fields:
          - "subscription_id"
          - "service_name"
          - "resource_group"
          - "resource_location"

  # Step 4: Convert to FOCUS 1.3 format
  # Runs the stored procedure to transform raw billing data to FOCUS standard
  - step_id: "convert_to_focus"
    name: "Convert to FOCUS 1.3"
    ps_type: "generic.bq_procedure"
    description: "Transform raw billing data to FOCUS 1.3 standard format"
    depends_on:
      - "extract_billing"
    config:
      procedure: "sp_cloud_1_convert_to_focus"
      dataset: "organizations"
      parameters:
        - name: "p_project_id"
          type: "STRING"
          value: "{gcp_project_id}"
        - name: "p_dataset_id"
          type: "STRING"
          value: "{org_slug}_{environment}"
        - name: "p_start_date"
          type: "DATE"
          value: "{start_date}"
        - name: "p_end_date"
          type: "DATE"
          value: "{end_date}"
        - name: "p_provider"
          type: "STRING"
          value: "azure"
        - name: "p_pipeline_id"
          type: "STRING"
          value: "{pipeline_id}"
        - name: "p_credential_id"
          type: "STRING"
          value: "{credential_id}"
        - name: "p_run_id"
          type: "STRING"
          value: "{run_id}"
    timeout_minutes: 30
    on_failure: "fail"

  # Step 5: Notification on failure
  - step_id: "notify_on_failure"
    name: "Notify on Failure"
    ps_type: "notify_systems.email_notification"
    description: "Send failure notification"
    trigger: "on_failure"
    config:
      to_emails:
        - "{admin_email}"
        - "data-ops@example.com"
      subject: "[ALERT] Azure Billing Pipeline Failed - {org_slug}"
      message: |
        ALERT: The Azure billing pipeline has failed!

        Organization: {org_slug}
        Pipeline: {pipeline_id}
        Run Date: {date}

requires_auth: true
auth_type: "org_api_key"

tags:
  - billing
  - azure
  - cost
  - daily
category: "cloud_cost"
