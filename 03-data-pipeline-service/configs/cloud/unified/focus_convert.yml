# Cloud Unified FOCUS 1.3 Conversion Pipeline
#
# Converts all cloud provider billing data to FOCUS 1.3 standard format
# Schedule: Daily at 6:30 AM UTC (after billing pipelines complete)
# URL: POST /api/v1/pipelines/run/{org}/cloud/unified/focus_convert

pipeline_id: "{org_slug}-cloud-unified-focus"
name: "Cloud FOCUS 1.3 Conversion"
description: "Convert cloud billing data from GCP, AWS, Azure, OCI to FOCUS 1.3 standard"
provider: "cloud"
domain: "unified"
version: "1.0.0"

schedule:
  cron: "30 6 * * *"
  timezone: "UTC"
  enabled: true

variables:
  org_slug: "{org_slug}"
  provider: "cloud"
  domain: "unified"

steps:
  # Step 1: Convert all cloud provider costs to FOCUS 1.3
  - step_id: convert_cloud_to_focus
    name: "Convert Cloud Costs to FOCUS 1.3"
    ps_type: generic.procedure_executor
    description: "Execute stored procedure to convert cloud billing data to FOCUS 1.3"
    config:
      procedure: "sp_convert_cloud_costs_to_focus_1_3"
      dataset: "organizations"  # Central dataset where procedure is stored
      parameters:
        p_project_id: "{project_id}"
        p_dataset_id: "{org_slug}_prod"
        p_cost_date: "{date}"
        p_provider: "all"  # Convert all providers
        p_pipeline_id: "focus_convert_cloud_unified"
        p_credential_id: "{credential_id}"
        p_run_id: "{run_id}"
    timeout_seconds: 600
    retry:
      max_attempts: 3
      backoff_seconds: 60

notifications:
  on_failure:
    - email
  on_success:
    - email  # Notify on completion of daily FOCUS conversion
