# Cloud Unified FOCUS 1.3 Conversion Pipeline
#
# Converts all cloud provider billing data to FOCUS 1.3 standard format
# Schedule: Daily at 6:30 AM UTC (after billing pipelines complete)
# URL: POST /api/v1/pipelines/run/{org}/cloud/unified/focus_convert

pipeline_id: "{org_slug}-cloud-unified-focus"
name: "Cloud FOCUS 1.3 Conversion"
description: "Convert cloud billing data from GCP, AWS, Azure, OCI to FOCUS 1.3 standard"
provider: "cloud"
domain: "unified"
version: "15.0.0"

schedule:
  cron: "30 6 * * *"
  timezone: "UTC"
  enabled: true

variables:
  org_slug: "{org_slug}"
  provider: "cloud"
  domain: "unified"

steps:
  # Step 1: Convert all cloud provider costs to FOCUS 1.3
  - step_id: convert_cloud_to_focus
    name: "Convert Cloud Costs to FOCUS 1.3"
    ps_type: generic.procedure_executor
    description: "Execute stored procedure to convert cloud billing data to FOCUS 1.3"
    config:
      procedure:
        name: "sp_cloud_1_convert_to_focus"
        dataset: "organizations"
      parameters:
        - name: "p_project_id"
          type: "STRING"
          value: "${project_id}"
        - name: "p_dataset_id"
          type: "STRING"
          value: "${org_dataset}"
        - name: "p_start_date"
          type: "DATE"
          value: "${start_date}"
        - name: "p_end_date"
          type: "DATE"
          value: "${end_date}"
        - name: "p_provider"
          type: "STRING"
          value: "all"
        - name: "p_pipeline_id"
          type: "STRING"
          value: "${pipeline_id}"
          optional: true
          default: "focus_convert_cloud_unified"
        - name: "p_credential_id"
          type: "STRING"
          value: "${credential_id}"
          optional: true
          default: "demo_credential"
        - name: "p_run_id"
          type: "STRING"
          value: "${run_id}"
          optional: true
    timeout_seconds: 600
    retry:
      max_attempts: 3
      backoff_seconds: 60

notifications:
  on_failure:
    - email
  on_success:
    - email  # Notify on completion of daily FOCUS conversion
