# OCI Cost Analysis Pipeline
# Extracts billing data from Oracle Cloud Infrastructure Cost Analysis
#
# Schedule: Daily at 06:00 UTC
# Tables: cloud_oci_billing_raw_daily
#
# Usage: POST /api/v1/pipelines/run/{org_slug}/oci/cost/billing
#
# PREREQUISITES:
# 1. Organization must have a valid OCI integration configured
# 2. OCI User must have Cost Analysis read access

pipeline_id: "{org_slug}-oci-billing"
name: "OCI Billing Sync"
description: "Extract OCI Cost Analysis data for {org_slug}"
version: "1.0.0"

# Schedule configuration (cron expression: daily at 06:00 UTC)
schedule: "0 6 * * *"

variables:
  org_slug: "{org_slug}"
  provider: "oci"
  domain: "cost"

steps:
  # Step 1: Authenticate with OCI
  - step_id: "authenticate"
    ps_type: "cloud.oci.authenticator"
    description: "Authenticate with OCI using API Key"
    config:
      provider: "OCI"
      require_valid: true
      context_key: "oci_credentials"
    on_failure: "abort"

  # Step 2: Extract Cost Data from OCI Cost Analysis API
  - step_id: "extract_costs"
    ps_type: "cloud.oci.cost_extractor"
    description: "Extract OCI Cost Analysis data for date range"
    depends_on:
      - "authenticate"
    timeout_minutes: 30
    config:
      date_filter: "{date}"
      granularity: "DAILY"
      # OCI Cost Analysis API options
      report_type: "COST"
      group_by:
        - "tenancy"
        - "compartment"
        - "service"
        - "region"

  # Step 3: Transform and Load to BigQuery
  - step_id: "load_to_bq"
    ps_type: "generic.bq_loader"
    description: "Load OCI cost data to BigQuery"
    depends_on:
      - "extract_costs"
    timeout_minutes: 20
    config:
      destination_table: "{org_slug}_prod.cloud_oci_billing_raw_daily"
      write_disposition: "WRITE_APPEND"
      partition_field: "usage_date"
      schema_template: "oci_billing_cost"
      table_config:
        time_partitioning:
          field: "usage_date"
          type: "DAY"
          expiration_days: 730
        clustering_fields:
          - "tenancy_id"
          - "service_name"
          - "compartment_id"
          - "region"

  # Step 4: Notification on failure
  - step_id: "notify_on_failure"
    ps_type: "notify_systems.email_notification"
    description: "Send failure notification"
    trigger: "on_failure"
    config:
      to_emails:
        - "{admin_email}"
        - "data-ops@example.com"
      subject: "[ALERT] OCI Billing Pipeline Failed - {org_slug}"
      message: |
        ALERT: The OCI billing pipeline has failed!

        Organization: {org_slug}
        Pipeline: {pipeline_id}
        Run Date: {date}

requires_auth: true
auth_type: "org_api_key"

tags:
  - billing
  - oci
  - cost
  - daily
category: "cloud_cost"
