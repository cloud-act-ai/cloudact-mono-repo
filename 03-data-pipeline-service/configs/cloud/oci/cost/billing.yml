# OCI Billing Pipeline
# Extracts billing data from Oracle Cloud Infrastructure Cost Analysis API, stores in BigQuery
#
# Schedule: Daily at 06:00 UTC (processes yesterday's data by default)
# Tables: cloud_oci_billing_raw_daily
#
# Usage:
#   POST /api/v1/pipelines/run/{org_slug}/oci/cost/billing
#   POST /api/v1/pipelines/run/{org_slug}/oci/cost/billing?start_date=2026-01-01&end_date=2026-01-22
#
# BEHAVIOR:
# - Default: Processes yesterday's data (T-1) based on usage_start_time
# - Idempotent: Deletes existing data for date range before inserting
# - Supports date ranges for backfill
#
# PREREQUISITES:
# 1. Organization must have a valid OCI integration configured
# 2. OCI User/Service Principal must have Cost Analysis read access
# 3. Tenancy OCID must be configured in the integration metadata
#
# OCI COST ANALYSIS API:
# - Uses UsageApi.RequestSummarizedUsages for cost data extraction
# - Supports granularity: DAILY, MONTHLY
# - Supports grouping by: tenancy, compartment, service, region, tag

pipeline_id: "{org_slug}-oci-billing"
name: "OCI Billing Sync"
description: "Extract OCI billing costs and store in BigQuery (idempotent, replaces existing data)"
provider: "oci"
domain: "cost"
version: "18.0.0"

# Schedule configuration (cron expression: daily at 06:00 UTC)
schedule: "0 6 * * *"

variables:
  org_slug: "{org_slug}"
  provider: "oci"
  # Multi-tenant: Use customer's OCI credentials to access their cost data
  use_org_credentials: "true"
  # Default date: Yesterday (T-1) - overridden by request parameters
  # Executor auto-calculates if not provided
  default_date_offset: "-1"

steps:
  # Step 1: Decrypt OCI credentials for customer's billing data
  - step_id: "decrypt_credentials"
    name: "Decrypt Credentials"
    ps_type: "integrations.kms_decrypt"
    description: "Load organization OCI credentials"
    enabled: "{use_org_credentials}"
    config:
      provider: "OCI"
      require_valid: true
      context_key: "oci_credentials"
    on_failure: "continue"

  # Step 2: Delete existing data for date range (idempotent - allows re-runs)
  # NOTE: Uses usage_start_time for filtering
  - step_id: "delete_existing_data"
    name: "Delete Existing Data"
    ps_type: "generic.bq_execute"
    description: "Delete existing billing data for date range to ensure idempotency"
    depends_on:
      - "decrypt_credentials"
    config:
      query: |
        DELETE FROM `{gcp_project_id}.{org_slug}_{environment}.cloud_oci_billing_raw_daily`
        WHERE DATE(usage_start_time) BETWEEN @start_date AND @end_date
          AND x_org_slug = @org_slug
      parameters:
        - name: "start_date"
          type: "DATE"
          value: "{start_date}"
        - name: "end_date"
          type: "DATE"
          value: "{end_date}"
        - name: "org_slug"
          type: "STRING"
          value: "{org_slug}"
    on_failure: "continue"  # Continue even if table doesn't exist yet

  # Step 3: Extract cost data from OCI Cost Analysis API
  - step_id: "extract_billing"
    name: "Extract Billing Data"
    ps_type: "cloud.oci.cost_extractor"
    description: "Extract OCI Cost Analysis data for date range"
    depends_on:
      - "delete_existing_data"
    timeout_minutes: 30

    source:
      # Multi-tenant: Use customer's OCI credentials to read their cost data
      use_org_credentials: true
      # OCI Cost Analysis API configuration
      api: "UsageApi.RequestSummarizedUsages"
      granularity: "DAILY"
      # Group by dimensions for detailed cost breakdown
      group_by:
        - "tenancyId"
        - "compartmentId"
        - "compartmentName"
        - "compartmentPath"
        - "service"
        - "skuName"
        - "skuPartNumber"
        - "resourceId"
        - "region"
        - "availabilityDomain"
        - "platform"
        - "unit"
      # Query type - COST for cost data, USAGE for raw usage
      query_type: "COST"

    # Transform OCI response to BigQuery schema
    transform:
      # Map OCI Cost Analysis fields to schema
      field_mapping:
        tenancy_id: "tenancyId"
        tenancy_name: "tenancyName"
        compartment_id: "compartmentId"
        compartment_name: "compartmentName"
        compartment_path: "compartmentPath"
        region: "region"
        availability_domain: "availabilityDomain"
        service_name: "service"
        sku_name: "skuName"
        sku_part_number: "skuPartNumber"
        resource_id: "resourceId"
        resource_name: "resourceName"
        usage_type: "usageType"
        unit: "unit"
        usage_start_time: "timeUsageStarted"
        usage_end_time: "timeUsageEnded"
        usage_quantity: "computedQuantity"
        computed_quantity: "computedQuantity"
        cost: "computedAmount"
        my_cost: "myCost"
        cost_type: "costType"
        list_rate: "listRate"
        unit_price: "unitPrice"
        currency: "currency"
        overage_flag: "overagesFlag"
        is_correction: "isCorrection"
        subscription_id: "subscriptionId"
        platform_type: "platform"
        billing_period: "billingPeriod"
        credits_total: "creditsTotal"
        credits_json: "creditsJson"
        freeform_tags_json: "freeformTags"
        defined_tags_json: "definedTags"

      # Add x_* pipeline lineage fields
      add_fields:
        x_ingestion_id: "GENERATE_UUID()"
        x_ingestion_date: "CURRENT_DATE()"
        x_org_slug: "'{org_slug}'"
        x_pipeline_id: "'{pipeline_id}'"
        x_credential_id: "'{credential_id}'"
        x_pipeline_run_date: "DATE('{start_date}')"
        x_run_id: "'{run_id}'"
        x_ingested_at: "CURRENT_TIMESTAMP()"
        x_cloud_provider: "'OCI'"
        x_cloud_account_id: "tenancyId"
        # Hierarchy mapping (OCI compartment = hierarchy entity)
        x_hierarchy_entity_id: "compartmentId"
        x_hierarchy_entity_name: "compartmentName"

    # Destination: Always CloudAct project + org dataset ({org_slug}_{env})
    destination:
      dataset_type: "oci"
      table: "cloud_oci_billing_raw_daily"
      write_mode: "append"
      schema_template: "billing_cost"
      table_config:
        time_partitioning:
          field: "x_ingestion_date"
          type: "DAY"
          expiration_days: 730
        clustering_fields:
          - "tenancy_id"
          - "service_name"
          - "compartment_id"
          - "region"

  # Step 4: Convert to FOCUS 1.3 format
  # Runs the stored procedure to transform raw billing data to FOCUS standard
  - step_id: "convert_to_focus"
    name: "Convert to FOCUS 1.3"
    ps_type: "generic.bq_procedure"
    description: "Transform raw billing data to FOCUS 1.3 standard format"
    depends_on:
      - "extract_billing"
    config:
      procedure: "sp_cloud_1_convert_to_focus"
      dataset: "organizations"
      parameters:
        - name: "p_project_id"
          type: "STRING"
          value: "{gcp_project_id}"
        - name: "p_dataset_id"
          type: "STRING"
          value: "{org_slug}_{environment}"
        - name: "p_start_date"
          type: "DATE"
          value: "{start_date}"
        - name: "p_end_date"
          type: "DATE"
          value: "{end_date}"
        - name: "p_provider"
          type: "STRING"
          value: "oci"
        - name: "p_pipeline_id"
          type: "STRING"
          value: "{pipeline_id}"
        - name: "p_credential_id"
          type: "STRING"
          value: "{credential_id}"
        - name: "p_run_id"
          type: "STRING"
          value: "{run_id}"
    timeout_minutes: 30
    on_failure: "fail"

  # Step 5: Notification on failure
  - step_id: "notify_on_failure"
    name: "Notify on Failure"
    ps_type: "notify_systems.email_notification"
    description: "Send failure notification"
    trigger: "on_failure"
    config:
      to_emails:
        - "{admin_email}"
        - "data-ops@example.com"
      subject: "[ALERT] OCI Billing Pipeline Failed - {org_slug}"
      message: |
        ALERT: The OCI billing pipeline has failed!

        Organization: {org_slug}
        Pipeline: {pipeline_id}
        Run Date: {date}

requires_auth: true
auth_type: "org_api_key"

tags:
  - billing
  - oci
  - cost
  - daily
category: "cloud_cost"
