# GCP Storage Buckets Pipeline
# Extracts Cloud Storage bucket inventory from GCP Storage API
#
# Schedule: Daily at 06:30 UTC
# Tables: gcp_storage_buckets_raw
#
# Usage: POST /api/v1/pipelines/run/{org_slug}/gcp/api/storage_buckets
#
# PREREQUISITES:
# 1. Organization must have a valid GCP_SA integration configured
# 2. The GCP Service Account must have storage.buckets.list permission
# 3. Cloud Storage API must be enabled in the GCP project

pipeline_id: "{org_slug}-gcp-storage-buckets"
name: "GCP Storage Buckets"
description: "Extract Cloud Storage bucket inventory from GCP Storage API"
version: "1.0.0"

# Schedule configuration (cron expression: daily at 06:30 UTC)
schedule: "30 6 * * *"

variables:
  org_slug: "{org_slug}"
  provider: "gcp"

steps:
  # Step 1: Extract storage buckets from Storage API
  - step_id: "extract_storage_buckets"
    ps_type: "gcp.api_extractor"
    description: "Extract all Cloud Storage buckets"
    timeout_minutes: 10

    config:
      # GCP Storage API configuration
      api: "storage.googleapis.com"
      endpoint: "/storage/v1/b?project={project_id}"
      method: "GET"

      # GCP pagination (nextPageToken pattern)
      pagination:
        page_size: 1000
        page_size_param: "maxResults"
        token_param: "pageToken"
        response_path: "nextPageToken"

      # JSON path to array of records
      data_path: "items"

      # Destination BigQuery table
      destination:
        table: "gcp_storage_buckets_raw"
        batch_size: 500
        key_fields:
          - "id"

      # Rate limiting
      rate_limit:
        requests_per_second: 10
        max_retries: 3

      # ELT pattern: store raw JSON
      transform:
        flatten: false
        add_fields:
          source_api: "storage"
          pipeline_version: "1.0.0"

  # Step 2: Notification on failure
  - step_id: "notify_on_failure"
    ps_type: "notify_systems.email_notification"
    description: "Send failure notification"
    trigger: "on_failure"
    config:
      to_emails:
        - "{admin_email}"
      subject: "[ALERT] GCP Storage Buckets Pipeline Failed - {org_slug}"
      message: |
        ALERT: The GCP Storage Buckets pipeline has failed!

        Organization: {org_slug}
        Pipeline: {pipeline_id}

        Please check the pipeline logs for details.

requires_auth: true
auth_type: "org_api_key"

tags:
  - storage
  - gcp
  - api
  - inventory
  - daily
category: "cloud_inventory"
