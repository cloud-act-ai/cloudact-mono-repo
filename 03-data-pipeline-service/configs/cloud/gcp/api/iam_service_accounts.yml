# GCP IAM Service Accounts Pipeline
# Extracts IAM service account inventory from GCP IAM API
#
# Schedule: Daily at 07:00 UTC
# Tables: gcp_iam_service_accounts_raw
#
# Usage: POST /api/v1/pipelines/run/{org_slug}/gcp/api/iam_service_accounts
#
# PREREQUISITES:
# 1. Organization must have a valid GCP_SA integration configured
# 2. The GCP Service Account must have iam.serviceAccounts.list permission
# 3. IAM API must be enabled in the GCP project

pipeline_id: "{org_slug}-gcp-iam-service-accounts"
name: "GCP IAM Service Accounts"
description: "Extract IAM service account inventory from GCP IAM API"
version: "1.0.0"

# Schedule configuration (cron expression: daily at 07:00 UTC)
schedule: "0 7 * * *"

variables:
  org_slug: "{org_slug}"
  provider: "gcp"

steps:
  # Step 1: Extract service accounts from IAM API
  - step_id: "extract_service_accounts"
    ps_type: "gcp.api_extractor"
    description: "Extract all IAM service accounts"
    timeout_minutes: 10

    config:
      # GCP IAM API configuration
      api: "iam.googleapis.com"
      endpoint: "/v1/projects/{project_id}/serviceAccounts"
      method: "GET"

      # GCP pagination (nextPageToken pattern)
      pagination:
        page_size: 100
        page_size_param: "pageSize"
        token_param: "pageToken"
        response_path: "nextPageToken"

      # JSON path to array of records
      data_path: "accounts"

      # Destination BigQuery table
      destination:
        table: "gcp_iam_service_accounts_raw"
        batch_size: 200
        key_fields:
          - "uniqueId"

      # Rate limiting (IAM API has strict limits)
      rate_limit:
        requests_per_second: 2
        max_retries: 3

      # ELT pattern: store raw JSON
      transform:
        flatten: false
        add_fields:
          source_api: "iam"
          pipeline_version: "1.0.0"

  # Step 2: Notification on failure
  - step_id: "notify_on_failure"
    ps_type: "notify_systems.email_notification"
    description: "Send failure notification"
    trigger: "on_failure"
    config:
      to_emails:
        - "{admin_email}"
      subject: "[ALERT] GCP IAM Service Accounts Pipeline Failed - {org_slug}"
      message: |
        ALERT: The GCP IAM Service Accounts pipeline has failed!

        Organization: {org_slug}
        Pipeline: {pipeline_id}

        Please check the pipeline logs for details.

requires_auth: true
auth_type: "org_api_key"

tags:
  - iam
  - gcp
  - api
  - security
  - inventory
  - daily
category: "cloud_inventory"
