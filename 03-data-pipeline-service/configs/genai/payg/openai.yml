# OpenAI PAYG Usage and Cost Pipeline
#
# Extracts usage from OpenAI API and calculates costs
# Schedule: Daily at 2:00 AM UTC
# URL: POST /api/v1/pipelines/run/{org}/genai/payg/openai

pipeline_id: "{org_slug}-genai-payg-openai"
name: "OpenAI PAYG Usage and Cost"
description: "Extract OpenAI token usage and calculate daily costs"
provider: "genai"
domain: "payg"
version: "15.0.0"

schedule:
  cron: "0 2 * * *"
  timezone: "UTC"  # All pipeline schedules use UTC for consistency across global deployments
  enabled: true

steps:
  - step_id: extract_usage
    name: "Extract OpenAI Usage"
    ps_type: genai.payg_usage
    config:
      provider: "openai"
      # Dates passed from context or API request
    timeout_seconds: 300
    retry:
      max_attempts: 3
      backoff_seconds: 30

  - step_id: calculate_costs
    name: "Calculate OpenAI Costs"
    ps_type: genai.payg_cost
    config:
      provider: "openai"
      # Dates are read from context (passed from API request or previous step)
    depends_on:
      - extract_usage
    timeout_seconds: 300
    retry:
      max_attempts: 3
      backoff_seconds: 30

requires_auth: true
auth_type: "org_api_key"

notifications:
  on_failure:
    - email
    - slack
  on_success: []
