ps_type: "setup.initial.onetime_bootstrap"
name: "One-Time Bootstrap Setup"
description: "Creates central organizations dataset and all management tables"
version: "1.1.0"

dataset:
  name: "organizations"
  description: "Central dataset for organization management"
  location: "US"

# Table configs - schema from schemas/{name}.json, partitioning/clustering defined here
tables:
  org_profiles:
    description: "Organization profiles"
    clustering: ["org_slug", "status"]

  org_api_keys:
    description: "API keys (SHA256 hashed)"
    partition:
      type: "DAY"
      field: "created_at"
    clustering: ["org_slug", "is_active"]

  org_subscriptions:
    description: "Subscription plans and limits"
    partition:
      type: "DAY"
      field: "created_at"
    clustering: ["org_slug", "status", "plan_name"]

  org_usage_quotas:
    description: "Usage tracking"
    partition:
      type: "DAY"
      field: "usage_date"
    clustering: ["org_slug", "usage_date"]

  org_integration_credentials:
    description: "Integration credentials for LLM providers and cloud accounts (KMS encrypted)"
    clustering: ["org_slug", "provider", "validation_status"]

  org_pipeline_configs:
    description: "Pipeline configurations"
    clustering: ["org_slug", "provider", "is_active"]

  org_scheduled_pipeline_runs:
    description: "Scheduled pipeline runs"
    partition:
      type: "DAY"
      field: "scheduled_time"
    clustering: ["org_slug", "state", "config_id"]

  org_pipeline_execution_queue:
    description: "Execution queue"
    partition:
      type: "DAY"
      field: "scheduled_time"
    clustering: ["state", "priority", "org_slug"]

  org_meta_pipeline_runs:
    description: "Pipeline execution logs"
    partition:
      type: "DAY"
      field: "start_time"
    clustering: ["org_slug", "status"]

  org_meta_step_logs:
    description: "Step execution logs"
    partition:
      type: "DAY"
      field: "start_time"
    clustering: ["org_slug", "pipeline_logging_id"]

  org_meta_state_transitions:
    description: "Pipeline and step state transition history for debugging and analytics"
    partition:
      type: "DAY"
      field: "transition_time"
    clustering: ["org_slug", "entity_type", "from_state", "to_state"]

  org_meta_dq_results:
    description: "Data quality results"
    partition:
      type: "DAY"
      field: "ingestion_date"
    clustering: ["org_slug", "overall_status"]

  # ============================================
  # Enterprise Multi-Tenancy Tables (P0 Fixes)
  # Note: User management, roles, and frontend rate limiting handled by Supabase
  # These tables are BigQuery-specific for backend operations
  # ============================================

  org_audit_logs:
    description: "Comprehensive audit logging for compliance (SOC2/HIPAA)"
    partition:
      type: "DAY"
      field: "created_at"
    clustering: ["org_slug", "action", "resource_type"]

  org_cost_tracking:
    description: "Cost tracking and usage metering for billing"
    partition:
      type: "DAY"
      field: "usage_date"
    clustering: ["org_slug", "resource_type", "provider"]

  org_idempotency_keys:
    description: "Idempotency key tracking for duplicate request prevention (24-hour TTL)"
    clustering: ["idempotency_key", "org_slug"]
