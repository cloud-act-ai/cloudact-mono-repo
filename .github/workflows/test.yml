name: Run Tests

on:
  push:
    branches:
      - main
      - 'feature/**'
      - 'fix/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  # ==================================================
  # Unit Tests - Run on every push
  # ==================================================
  unit-tests:
    name: Unit Tests (${{ matrix.service }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - api-service
          - pipeline-service
        include:
          - service: api-service
            path: 02-api-service
            test_path: tests/
          - service: pipeline-service
            path: 03-data-pipeline-service
            test_path: tests/

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: ${{ matrix.path }}/requirements.txt

      - name: Install dependencies
        run: |
          cd ${{ matrix.path }}
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov pytest-xdist httpx

      - name: Run unit tests
        run: |
          cd ${{ matrix.path }}
          python -m pytest ${{ matrix.test_path }} \
            -v \
            -m "not integration and not e2e and not slow" \
            --cov=src \
            --cov-report=xml \
            --cov-report=term-missing \
            --tb=short \
            -x \
            --ignore=${{ matrix.test_path }}/test_00_health.py
        env:
          PYTHONPATH: ${{ github.workspace }}/${{ matrix.path }}

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ${{ matrix.path }}/coverage.xml
          flags: ${{ matrix.service }}
          name: ${{ matrix.service }}-coverage
          fail_ci_if_error: false

  # ==================================================
  # Security Tests - Run on every push
  # ==================================================
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 02-api-service/requirements.txt

      - name: Install dependencies
        run: |
          cd 02-api-service
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx

      - name: Run security tests (mocked)
        run: |
          cd 02-api-service
          python -m pytest tests/ \
            -v \
            -m "security" \
            --tb=short \
            -k "not cross_org" \
            || echo "Security tests completed (some may be skipped without live server)"
        env:
          PYTHONPATH: ${{ github.workspace }}/02-api-service

  # ==================================================
  # Cost Calculation Unit Tests - Pure math, no external deps
  # ==================================================
  cost-calculation-tests:
    name: Cost Calculation Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install minimal dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run pure unit tests
        run: |
          cd 03-data-pipeline-service
          python -m pytest tests/test_05b_saas_cost_calculation_unit.py -v --tb=short

  # ==================================================
  # Integration Tests - Only on main branch or manual trigger
  # ==================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 02-api-service/requirements.txt

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_STAGE }}

      - name: Install API Service dependencies
        run: |
          cd 02-api-service
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx

      - name: Run API Service integration tests
        run: |
          cd 02-api-service
          python -m pytest tests/ \
            -v \
            -m "integration" \
            --tb=short \
            --run-integration
        env:
          PYTHONPATH: ${{ github.workspace }}/02-api-service
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID_STAGE }}
          CA_ROOT_API_KEY: ${{ secrets.CA_ROOT_API_KEY_STAGE }}
          RUN_INTEGRATION_TESTS: "true"
          ENVIRONMENT: "staging"
        continue-on-error: true

      - name: Install Pipeline Service dependencies
        run: |
          cd 03-data-pipeline-service
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx

      - name: Run Pipeline Service integration tests
        run: |
          cd 03-data-pipeline-service
          python -m pytest tests/ \
            -v \
            -m "integration or e2e" \
            --tb=short
        env:
          PYTHONPATH: ${{ github.workspace }}/03-data-pipeline-service
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID_STAGE }}
          CA_ROOT_API_KEY: ${{ secrets.CA_ROOT_API_KEY_STAGE }}
          RUN_E2E_TESTS: "true"
          ENVIRONMENT: "staging"
        continue-on-error: true

  # ==================================================
  # Lint and Type Check
  # ==================================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - name: Run Ruff on API Service
        run: |
          cd 02-api-service
          ruff check src/ --exit-zero
        continue-on-error: true

      - name: Run Ruff on Pipeline Service
        run: |
          cd 03-data-pipeline-service
          ruff check src/ --exit-zero
        continue-on-error: true

  # ==================================================
  # Test Summary
  # ==================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, security-tests, cost-calculation-tests, lint]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "==================================================="
          echo "TEST SUMMARY"
          echo "==================================================="
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Security Tests: ${{ needs.security-tests.result }}"
          echo "Cost Calculation Tests: ${{ needs.cost-calculation-tests.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "==================================================="

          if [ "${{ needs.unit-tests.result }}" = "failure" ]; then
            echo "Unit tests failed!"
            exit 1
          fi

          if [ "${{ needs.cost-calculation-tests.result }}" = "failure" ]; then
            echo "Cost calculation tests failed!"
            exit 1
          fi

          echo "All required tests passed!"
