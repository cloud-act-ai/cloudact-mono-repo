#!/bin/bash
################################################################################
# environments.conf - Environment Configuration
# Source this file to get environment-specific settings
################################################################################

# Get project ID for environment
get_project_id() {
    local env=$1
    case $env in
        test)  echo "cloudact-testing-1" ;;
        stage) echo "cloudact-stage" ;;
        prod)  echo "cloudact-prod" ;;
        *)     echo ""; return 1 ;;
    esac
}

# Get credentials path for environment
get_credentials_path() {
    local env=$1
    case $env in
        test)  echo "$HOME/.gcp/cloudact-testing-1-e44da390bf82.json" ;;
        stage) echo "$HOME/.gcp/cloudact-stage.json" ;;
        prod)  echo "$HOME/.gcp/cloudact-prod.json" ;;
        *)     echo ""; return 1 ;;
    esac
}

# Get service account for environment
get_service_account() {
    local env=$1
    local project_id=$(get_project_id $env)
    echo "cloudact-sa-${env}@${project_id}.iam.gserviceaccount.com"
}

# Activate environment (sets gcloud project and credentials)
activate_env() {
    local env=$1
    local project_id=$(get_project_id $env)
    local creds_path=$(get_credentials_path $env)

    if [ -z "$project_id" ]; then
        echo "Error: Invalid environment '$env'. Use: test, stage, prod"
        return 1
    fi

    echo "Activating environment: $env"
    echo "  Project: $project_id"

    # Set gcloud project
    gcloud config set project $project_id

    # Set credentials if file exists
    if [ -f "$creds_path" ]; then
        export GOOGLE_APPLICATION_CREDENTIALS="$creds_path"
        echo "  Credentials: $creds_path"
    else
        echo "  Credentials: Using default (ADC/service account)"
    fi

    # Configure Docker auth
    gcloud auth configure-docker gcr.io --quiet

    echo ""
    echo "Environment '$env' activated!"
}

# Environment settings summary
env_summary() {
    echo "CloudAct Environment Configuration"
    echo "==================================="
    echo ""
    for env in test stage prod; do
        local project=$(get_project_id $env)
        local creds=$(get_credentials_path $env)
        local sa=$(get_service_account $env)
        local creds_status="[FOUND]"
        [ ! -f "$creds" ] && creds_status="[MISSING]"

        echo "$env:"
        echo "  Project:     $project"
        echo "  Credentials: $creds $creds_status"
        echo "  SA:          $sa"
        echo ""
    done
}

# Services list
SERVICES=("api-service" "pipeline-service" "frontend")

# Region (same for all environments)
REGION="us-central1"
