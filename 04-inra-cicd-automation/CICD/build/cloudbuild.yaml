# Cloud Build configuration for CloudAct services
# Used by build.sh - substitutions provided at runtime

steps:
  # Build the Docker image with build args
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '--platform=linux/amd64'
      - '--build-arg=ENVIRONMENT=${_ENVIRONMENT}'
      - '--build-arg=TARGET_ENV=${_TARGET_ENV}'
      - '--build-arg=VERSION=${_VERSION}'
      - '--build-arg=BUILD_DATE=${_BUILD_DATE}'
      - '--build-arg=GIT_COMMIT=${_GIT_COMMIT}'
      - '-t'
      - '${_IMAGE_VERSION}'
      - '-t'
      - '${_IMAGE_LATEST}'
      - '-t'
      - '${_IMAGE_ENV_LATEST}'
      - '.'

# Push all tagged images
images:
  - '${_IMAGE_VERSION}'
  - '${_IMAGE_LATEST}'
  - '${_IMAGE_ENV_LATEST}'

# Build options
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'

# Timeout (30 minutes)
timeout: '1800s'
