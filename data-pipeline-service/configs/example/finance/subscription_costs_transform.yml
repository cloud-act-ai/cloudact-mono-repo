# Pipeline: Subscription Costs Transformation
# Domain: Finance
# Action: Transform (Calculate total costs from multiple sources)

pipeline_id: "subscription-costs-calc"
name: "Subscription Costs Calculation"
description: "Consolidate GCP and OpenAI costs into a single view"
version: "1.0.0"

schedule:
  type: daily
  time: "04:00" # Run after upstream extractors
  timezone: UTC

variables:
  org_slug: "{org_slug}"

steps:
  - step_id: "consolidate_costs"
    ps_type: "generic.local_bq_transformer" # Uses src/core/processors/generic/local_bq_transformer.py
    description: "Join GCP and OpenAI cost tables"
    timeout_minutes: 10

    # Configuration passed to the processor
    config:
      start_date: "{start_date}"

    # Transformation Logic (SQL Template)
    transformation:
      type: "sql_template"
      sql: |
        SELECT 
          COALESCE(t1.usage_date, t2.usage_date) as usage_date,
          '{org_slug}' as org_slug,
          IFNULL(t1.cost, 0) as gcp_cost,
          IFNULL(t2.estimated_cost_usd, 0) as openai_cost,
          (IFNULL(t1.cost, 0) + IFNULL(t2.estimated_cost_usd, 0)) as total_cost
        FROM `{project}.{dataset}.gcp_billing_daily_raw` t1
        FULL OUTER JOIN `{project}.{dataset}.openai_cost_daily` t2 
          ON t1.usage_date = t2.usage_date 
          AND t1.org_slug = t2.org_slug
        WHERE COALESCE(t1.usage_date, t2.usage_date) = '{{ start_date }}'

    # Destination Configuration
    destination:
      table: "consolidated_subscription_costs_daily"
      mode: "append" # Append daily results

requires_auth: true
auth_type: "org_api_key"

tags:
  - finance
  - cost
  - transformation
category: "finance"
