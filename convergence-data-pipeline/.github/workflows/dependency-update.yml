name: Dependency Update - Auto-update Dependencies

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - security
        default: 'patch'

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: Check for Updates
  check-updates:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      update_summary: ${{ steps.check.outputs.update_summary }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools safety

      - name: Check for outdated packages
        id: check
        run: |
          pip install -r requirements.txt

          # Get list of outdated packages
          outdated=$(pip list --outdated --format=json)
          echo "Outdated packages:"
          echo "$outdated" | python -m json.tool

          # Count updates
          count=$(echo "$outdated" | python -c "import sys, json; print(len(json.load(sys.stdin)))")

          if [[ $count -gt 0 ]]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "Found $count outdated packages"

            # Create summary
            summary=$(echo "$outdated" | python -c "
          import sys, json
          data = json.load(sys.stdin)
          for pkg in data[:10]:  # Limit to first 10
              print(f\"- {pkg['name']}: {pkg['version']} -> {pkg['latest_version']}\")
          if len(data) > 10:
              print(f\"... and {len(data) - 10} more\")
          ")

            echo "update_summary<<EOF" >> $GITHUB_OUTPUT
            echo "$summary" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No updates available"
          fi

  # Job 2: Security Updates
  security-updates:
    name: Apply Security Updates
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.has_updates == 'true' || github.event.inputs.update_type == 'security'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install tools
        run: |
          python -m pip install --upgrade pip
          pip install safety pip-audit

      - name: Check for security vulnerabilities
        id: security-check
        run: |
          # Run safety check
          safety check --file requirements.txt --json > safety-report.json || true

          # Run pip-audit
          pip-audit -r requirements.txt --format json > audit-report.json || true

          # Check if vulnerabilities found
          vuln_count=$(cat safety-report.json | python -c "import sys, json; data=json.load(sys.stdin); print(len(data.get('vulnerabilities', [])))" 2>/dev/null || echo "0")

          if [[ $vuln_count -gt 0 ]]; then
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "Found $vuln_count vulnerabilities"
          else
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            safety-report.json
            audit-report.json
          retention-days: 30

  # Job 3: Update Dependencies
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    needs: [check-updates, security-updates]
    if: needs.check-updates.outputs.has_updates == 'true'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools

      - name: Backup current requirements
        run: |
          cp requirements.txt requirements.txt.backup

      - name: Update dependencies
        id: update
        run: |
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'patch' }}"

          case $UPDATE_TYPE in
            major)
              echo "Updating all dependencies to latest versions"
              pip-compile --upgrade --output-file requirements.txt requirements.txt
              ;;
            minor)
              echo "Updating minor versions"
              pip-compile --upgrade-package '*' --output-file requirements.txt requirements.txt
              ;;
            security)
              echo "Updating only security patches"
              # Update packages with known vulnerabilities
              pip-compile --upgrade --output-file requirements.txt requirements.txt
              ;;
            *)
              echo "Updating patch versions"
              pip-compile --upgrade --output-file requirements.txt requirements.txt
              ;;
          esac

      - name: Test updated dependencies
        run: |
          pip install -r requirements.txt
          python -c "import sys; print(f'Python {sys.version}')"

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet requirements.txt; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to requirements.txt"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in requirements.txt"
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore(deps): Update Python dependencies

            Automated dependency update - ${{ github.event.inputs.update_type || 'scheduled' }}

            Updates:
            ${{ needs.check-updates.outputs.update_summary }}
          branch: deps/update-${{ github.run_number }}
          delete-branch: true
          title: 'chore(deps): Update Python dependencies'
          body: |
            ## Dependency Updates

            This PR updates Python dependencies.

            **Update Type:** ${{ github.event.inputs.update_type || 'scheduled patch updates' }}

            ### Updated Packages
            ${{ needs.check-updates.outputs.update_summary }}

            ### Security Status
            - Security vulnerabilities: ${{ needs.security-updates.outputs.has_vulnerabilities || 'None detected' }}

            ### Testing
            - [ ] All tests pass
            - [ ] No breaking changes detected
            - [ ] Security scan completed

            ### Deployment Plan
            1. Review changes
            2. Merge to develop
            3. Deploy to staging
            4. Verify functionality
            5. Deploy to production

            ---
            *This PR was automatically created by the dependency update workflow*
          labels: |
            dependencies
            automated
          assignees: ${{ github.actor }}

  # Job 4: Dependabot Alternative - GitHub Updates
  check-github-actions:
    name: Check GitHub Actions Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for action updates
        run: |
          echo "Checking for GitHub Actions updates..."

          # Find all workflow files
          for file in .github/workflows/*.yml; do
            echo "Checking $file"
            grep -E "uses: .+@v[0-9]+" "$file" || true
          done

  # Job 5: Create Security Advisory
  security-advisory:
    name: Create Security Advisory
    runs-on: ubuntu-latest
    needs: security-updates
    if: needs.security-updates.outputs.has_vulnerabilities == 'true'
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download security reports
        uses: actions/download-artifact@v4
        with:
          name: security-reports

      - name: Create issue for vulnerabilities
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('safety-report.json', 'utf8'));

            const vulnCount = report.vulnerabilities?.length || 0;

            if (vulnCount > 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Security: ${vulnCount} vulnerabilities found in dependencies`,
                body: `Security scan found ${vulnCount} vulnerabilities in project dependencies.\n\nPlease review the security reports and update dependencies immediately.\n\n**Action Required:**\n- Review vulnerability report\n- Update affected packages\n- Run security tests\n- Deploy updates\n\nSee attached security reports for details.`,
                labels: ['security', 'dependencies', 'high-priority']
              });
            }

  # Job 6: Summary Report
  summary:
    name: Update Summary
    runs-on: ubuntu-latest
    needs: [check-updates, security-updates, update-dependencies]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Dependency Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Updates Available:** ${{ needs.check-updates.outputs.has_updates }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Security Vulnerabilities:** ${{ needs.security-updates.outputs.has_vulnerabilities || 'None' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package Updates" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.check-updates.outputs.update_summary }}" >> $GITHUB_STEP_SUMMARY
