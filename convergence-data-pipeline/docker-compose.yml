version: '3.8'

services:
  convergence-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: convergence-data-pipeline
    ports:
      - "8080:8080"
    environment:
      # GCP Configuration
      - GOOGLE_APPLICATION_CREDENTIALS=/app/gcp-credentials.json
      - GCP_PROJECT_ID=${GCP_PROJECT_ID:-gac-prod-471220}
      - BIGQUERY_LOCATION=${BIGQUERY_LOCATION:-US}

      # Application Configuration
      - APP_NAME=convergence-data-pipeline
      - APP_VERSION=1.0.0
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTHONPATH=/app

      # API Configuration
      - API_HOST=0.0.0.0
      - API_PORT=8080
      - API_WORKERS=1

      # Security Configuration
      - DISABLE_AUTH=${DISABLE_AUTH:-true}
      - ENABLE_DEV_MODE=${ENABLE_DEV_MODE:-true}
      - DEFAULT_TENANT_ID=${DEFAULT_TENANT_ID:-acme1281}
      - API_KEY_SECRET_KEY=${API_KEY_SECRET_KEY:-change-this-in-production}
      - ADMIN_API_KEY=${ADMIN_API_KEY:-admin-test-key-123}

      # BigQuery Configuration
      - BQ_MAX_RESULTS_PER_PAGE=10000
      - BQ_QUERY_TIMEOUT_SECONDS=300

      # Pipeline Configuration
      - CONFIGS_BASE_PATH=/app/configs
      - METADATA_SCHEMAS_PATH=ps_templates/setup/initial/schemas
      - TENANT_ONBOARDING_SCHEMAS_PATH=ps_templates/setup/tenants/onboarding/schemas

      # Lock Configuration
      - LOCK_BACKEND=memory
      - LOCK_TIMEOUT_SECONDS=3600

    volumes:
      # Mount GCP credentials
      - ${GOOGLE_APPLICATION_CREDENTIALS:-~/.gcp/gac-prod-471220-e34944040b62.json}:/app/gcp-credentials.json:ro
      # Mount configs for development (optional - already in image)
      # - ./configs:/app/configs:ro
      # - ./ps_templates:/app/ps_templates:ro

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    networks:
      - convergence-network

networks:
  convergence-network:
    driver: bridge
