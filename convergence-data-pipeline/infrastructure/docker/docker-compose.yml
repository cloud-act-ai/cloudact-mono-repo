# ============================================
# Docker Compose - Local Development Environment
# ============================================
# Provides a complete local development environment with:
# - Convergence Pipeline API
# - PostgreSQL database (optional - for metadata)
# - Redis cache (optional - for rate limiting)
# - BigQuery emulator (optional - for testing)
# ============================================

version: '3.9'

# ============================================
# Services
# ============================================
services:
  # ============================================
  # Convergence Pipeline API
  # ============================================
  api:
    build:
      context: ../..  # Root of the project
      dockerfile: infrastructure/docker/Dockerfile
      args:
        APP_VERSION: "dev"
        BUILD_DATE: "${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}"
        VCS_REF: "${VCS_REF:-local}"

    image: convergence-pipeline:dev
    container_name: convergence-api

    ports:
      - "8000:8000"

    environment:
      # Application
      APP_NAME: "Convergence Data Pipeline"
      APP_VERSION: "dev"
      ENVIRONMENT: "development"
      DEBUG: "true"

      # API
      API_HOST: "0.0.0.0"
      API_PORT: "8000"
      API_RELOAD: "true"

      # GCP (use your actual project)
      GCP_PROJECT_ID: "${GCP_PROJECT_ID:-your-project-id}"
      GCP_REGION: "${GCP_REGION:-us-central1}"

      # BigQuery
      BQ_DATASET_ID: "convergence_metadata_dev"
      BQ_LOCATION: "US"

      # Logging
      LOG_LEVEL: "DEBUG"
      LOG_FORMAT: "text"  # Use "json" for structured logging

      # Rate Limiting
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_REQUESTS_PER_MINUTE: "100"
      RATE_LIMIT_REQUESTS_PER_HOUR: "1000"

      # CORS
      CORS_ORIGINS: '["*"]'
      CORS_ALLOW_CREDENTIALS: "true"

      # Features
      ENABLE_TRACING: "false"  # Disable for local dev
      ENABLE_METRICS: "true"

      # Database (if using PostgreSQL)
      # DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/convergence"

      # Redis (if using for caching)
      # REDIS_URL: "redis://redis:6379/0"

    env_file:
      - ../../.env  # Load from root .env file

    volumes:
      # Mount source code for hot reload
      - ../../src:/app/src:ro
      - ../../templates:/app/templates:ro
      # Mount logs directory
      - api-logs:/app/logs

    networks:
      - convergence-network

    depends_on:
      - postgres
      - redis

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/live"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

    restart: unless-stopped

  # ============================================
  # PostgreSQL (Optional - for metadata storage)
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: convergence-postgres

    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: convergence
      PGDATA: /var/lib/postgresql/data/pgdata

    ports:
      - "5432:5432"

    volumes:
      - postgres-data:/var/lib/postgresql/data
      # Optional: mount init scripts
      # - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro

    networks:
      - convergence-network

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

    restart: unless-stopped

  # ============================================
  # Redis (Optional - for caching and rate limiting)
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: convergence-redis

    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru

    ports:
      - "6379:6379"

    volumes:
      - redis-data:/data

    networks:
      - convergence-network

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

    restart: unless-stopped

  # ============================================
  # BigQuery Emulator (Optional - for testing)
  # ============================================
  # Note: This is a community emulator, not official Google
  # bigquery-emulator:
  #   image: ghcr.io/goccy/bigquery-emulator:latest
  #   container_name: convergence-bigquery-emulator
  #
  #   ports:
  #     - "9050:9050"
  #
  #   environment:
  #     - PROJECT_ID=${GCP_PROJECT_ID:-your-project-id}
  #
  #   networks:
  #     - convergence-network
  #
  #   restart: unless-stopped

  # ============================================
  # Prometheus (Optional - for metrics)
  # ============================================
  # prometheus:
  #   image: prom/prometheus:latest
  #   container_name: convergence-prometheus
  #
  #   ports:
  #     - "9090:9090"
  #
  #   volumes:
  #     - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
  #     - prometheus-data:/prometheus
  #
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--storage.tsdb.path=/prometheus'
  #
  #   networks:
  #     - convergence-network
  #
  #   restart: unless-stopped

  # ============================================
  # Grafana (Optional - for dashboards)
  # ============================================
  # grafana:
  #   image: grafana/grafana:latest
  #   container_name: convergence-grafana
  #
  #   ports:
  #     - "3000:3000"
  #
  #   environment:
  #     - GF_SECURITY_ADMIN_PASSWORD=admin
  #     - GF_USERS_ALLOW_SIGN_UP=false
  #
  #   volumes:
  #     - grafana-data:/var/lib/grafana
  #
  #   networks:
  #     - convergence-network
  #
  #   depends_on:
  #     - prometheus
  #
  #   restart: unless-stopped

# ============================================
# Networks
# ============================================
networks:
  convergence-network:
    driver: bridge
    name: convergence-network

# ============================================
# Volumes
# ============================================
volumes:
  postgres-data:
    name: convergence-postgres-data
  redis-data:
    name: convergence-redis-data
  api-logs:
    name: convergence-api-logs
  # prometheus-data:
  #   name: convergence-prometheus-data
  # grafana-data:
  #   name: convergence-grafana-data

# ============================================
# Usage Instructions
# ============================================
# Start all services:
#   docker-compose -f infrastructure/docker/docker-compose.yml up -d
#
# Start specific service:
#   docker-compose -f infrastructure/docker/docker-compose.yml up -d api
#
# View logs:
#   docker-compose -f infrastructure/docker/docker-compose.yml logs -f api
#
# Stop all services:
#   docker-compose -f infrastructure/docker/docker-compose.yml down
#
# Stop and remove volumes:
#   docker-compose -f infrastructure/docker/docker-compose.yml down -v
#
# Rebuild and restart:
#   docker-compose -f infrastructure/docker/docker-compose.yml up -d --build
#
# Access services:
#   API:        http://localhost:8000
#   API Docs:   http://localhost:8000/docs
#   PostgreSQL: localhost:5432
#   Redis:      localhost:6379
#   Prometheus: http://localhost:9090
#   Grafana:    http://localhost:3000
# ============================================
