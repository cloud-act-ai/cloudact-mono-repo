pipeline:
  id: "bq_etl_test"
  name: "BQ ETL Test Pipeline"
  description: "Tests BigQuery ETL operations for tenant onboarding validation"
  version: "1.0.0"
  trigger_type: "manual"

dependencies:
  level_1:
    - step: create_sample_data
  level_2:
    - step: transform_data
  level_3:
    - step: validate_results

steps:
  - id: create_sample_data
    name: "Create Sample Data"
    description: "Insert sample records for validation"
    ps_type: "bq_etl.query"
    config:
      source_query: |
        SELECT
          GENERATE_UUID() as record_id,
          'Test Record' as record_type,
          'BQ ETL Test Pipeline' as source,
          CURRENT_TIMESTAMP() as created_at,
          'ACTIVE' as status
        UNION ALL
        SELECT
          GENERATE_UUID() as record_id,
          'Validation Record' as record_type,
          'Onboarding Test' as source,
          CURRENT_TIMESTAMP() as created_at,
          'PENDING' as status
      target_table: "${tenant_id}.test_sample_data"
      write_disposition: "WRITE_TRUNCATE"
      create_table_if_needed: true

  - id: transform_data
    name: "Transform Sample Data"
    description: "Process and transform the sample data"
    ps_type: "bq_etl.query"
    config:
      source_query: |
        SELECT
          record_id,
          UPPER(record_type) as record_type_upper,
          CONCAT(source, ' - Processed') as processed_source,
          created_at,
          CASE
            WHEN status = 'PENDING' THEN 'ACTIVE'
            ELSE status
          END as updated_status,
          CURRENT_TIMESTAMP() as processed_at
        FROM ${tenant_id}.test_sample_data
      target_table: "${tenant_id}.test_transformed_data"
      write_disposition: "WRITE_TRUNCATE"
      create_table_if_needed: true

  - id: validate_results
    name: "Validate Results"
    description: "Verify data was processed correctly"
    ps_type: "bq_etl.query"
    config:
      source_query: |
        WITH validation AS (
          SELECT
            COUNT(*) as total_records,
            COUNT(DISTINCT record_id) as unique_records,
            COUNT(CASE WHEN updated_status = 'ACTIVE' THEN 1 END) as active_records,
            MIN(processed_at) as first_processed,
            MAX(processed_at) as last_processed
          FROM ${tenant_id}.test_transformed_data
        )
        SELECT
          'Validation Complete' as status,
          total_records,
          unique_records,
          active_records,
          TIMESTAMP_DIFF(last_processed, first_processed, SECOND) as processing_time_seconds,
          CURRENT_TIMESTAMP() as validation_timestamp
        FROM validation
      target_table: "${tenant_id}.test_validation_results"
      write_disposition: "WRITE_APPEND"
      create_table_if_needed: true

metadata:
  tags:
    - "test"
    - "bq_etl"
    - "validation"
  environment: "all"
  retention_days: 7