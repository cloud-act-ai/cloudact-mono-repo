{
  "data_asset_type": "Dataset",
  "expectation_suite_name": "billing_cost_suite",
  "meta": {
    "great_expectations_version": "0.18.0",
    "description": "Data quality validation suite for GCP billing cost data",
    "created_by": "convergence-data-pipeline",
    "created_date": "2025-11-16",
    "target_table": "billing_cost_daily"
  },
  "expectations": [
    {
      "expectation_type": "expect_table_row_count_to_be_between",
      "kwargs": {
        "min_value": 1,
        "max_value": 10000000
      },
      "meta": {
        "description": "Billing data should have at least 1 row and not exceed 10M rows per partition",
        "severity": "critical",
        "notes": "Ensures data was actually loaded and catches runaway queries"
      }
    },
    {
      "expectation_type": "expect_table_columns_to_match_set",
      "kwargs": {
        "column_set": [
          "billing_account_id",
          "service_id",
          "service_description",
          "sku_id",
          "sku_description",
          "usage_start_time",
          "usage_end_time",
          "project_id",
          "project_name",
          "project_number",
          "location_location",
          "location_region",
          "location_zone",
          "resource_name",
          "resource_global_name",
          "cost",
          "currency",
          "currency_conversion_rate",
          "usage_amount",
          "usage_unit",
          "usage_amount_in_pricing_units",
          "usage_pricing_unit",
          "cost_type",
          "credits_total",
          "cost_at_list",
          "invoice_month",
          "ingestion_date",
          "labels_json",
          "system_labels_json"
        ]
      },
      "meta": {
        "description": "Validate that all expected columns are present in the table",
        "severity": "critical",
        "notes": "Schema validation - catches missing columns from source"
      }
    },
    {
      "expectation_type": "expect_column_values_to_not_be_null",
      "kwargs": {
        "column": "billing_account_id"
      },
      "meta": {
        "description": "Billing account ID is required for organization mapping",
        "severity": "critical",
        "notes": "Primary key for multi-organization cost allocation"
      }
    },
    {
      "expectation_type": "expect_column_values_to_not_be_null",
      "kwargs": {
        "column": "cost"
      },
      "meta": {
        "description": "Cost value must be present (can be 0.0)",
        "severity": "critical",
        "notes": "Core business metric - missing costs would break reporting"
      }
    },
    {
      "expectation_type": "expect_column_values_to_not_be_null",
      "kwargs": {
        "column": "usage_start_time"
      },
      "meta": {
        "description": "Usage start time is required for time-based analysis",
        "severity": "critical",
        "notes": "Critical dimension for cost trend analysis"
      }
    },
    {
      "expectation_type": "expect_column_values_to_not_be_null",
      "kwargs": {
        "column": "usage_end_time"
      },
      "meta": {
        "description": "Usage end time is required for time-based analysis",
        "severity": "critical",
        "notes": "Critical dimension for cost trend analysis"
      }
    },
    {
      "expectation_type": "expect_column_values_to_not_be_null",
      "kwargs": {
        "column": "ingestion_date"
      },
      "meta": {
        "description": "Ingestion date is required as partition key",
        "severity": "critical",
        "notes": "Table is partitioned by this field - must not be null"
      }
    },
    {
      "expectation_type": "expect_column_values_to_be_between",
      "kwargs": {
        "column": "cost",
        "min_value": -1000000.0,
        "max_value": 1000000.0,
        "mostly": 0.99
      },
      "meta": {
        "description": "Cost values should be within reasonable range (-$1M to +$1M)",
        "severity": "warning",
        "notes": "Catches data quality issues and anomalies. Negative costs are credits/refunds. 99% of values should be in range."
      }
    },
    {
      "expectation_type": "expect_column_values_to_be_between",
      "kwargs": {
        "column": "cost",
        "min_value": 0.0,
        "max_value": null,
        "mostly": 0.95
      },
      "meta": {
        "description": "Most costs should be positive (95%+)",
        "severity": "info",
        "notes": "Negative costs represent credits. If > 5% are negative, investigate."
      }
    },
    {
      "expectation_type": "expect_column_values_to_be_in_set",
      "kwargs": {
        "column": "currency",
        "value_set": ["USD", "EUR", "GBP", "CAD", "AUD", "JPY", "INR", null],
        "mostly": 0.95
      },
      "meta": {
        "description": "Currency should be one of the common billing currencies",
        "severity": "warning",
        "notes": "Helps catch currency conversion issues"
      }
    },
    {
      "expectation_type": "expect_column_values_to_match_regex",
      "kwargs": {
        "column": "billing_account_id",
        "regex": "^[0-9A-F]{6}-[0-9A-F]{6}-[0-9A-F]{6}$",
        "mostly": 0.95
      },
      "meta": {
        "description": "Billing account ID should match GCP format (XXXXXX-XXXXXX-XXXXXX)",
        "severity": "warning",
        "notes": "Standard GCP billing account format validation"
      }
    },
    {
      "expectation_type": "expect_column_values_to_match_regex",
      "kwargs": {
        "column": "service_id",
        "regex": "^[a-z0-9\\-]+\\.googleapis\\.com$",
        "mostly": 0.90
      },
      "meta": {
        "description": "Service ID should match GCP API format (*.googleapis.com)",
        "severity": "info",
        "notes": "Standard GCP service identifier format"
      }
    },
    {
      "expectation_type": "expect_column_values_to_be_dateutil_parseable",
      "kwargs": {
        "column": "usage_start_time"
      },
      "meta": {
        "description": "Usage start time must be valid timestamp",
        "severity": "critical",
        "notes": "Ensures timestamp fields are properly formatted"
      }
    },
    {
      "expectation_type": "expect_column_values_to_be_dateutil_parseable",
      "kwargs": {
        "column": "usage_end_time"
      },
      "meta": {
        "description": "Usage end time must be valid timestamp",
        "severity": "critical",
        "notes": "Ensures timestamp fields are properly formatted"
      }
    },
    {
      "expectation_type": "expect_column_pair_values_A_to_be_greater_than_B",
      "kwargs": {
        "column_A": "usage_end_time",
        "column_B": "usage_start_time",
        "or_equal": true,
        "mostly": 0.99
      },
      "meta": {
        "description": "Usage end time should be >= usage start time",
        "severity": "warning",
        "notes": "Logical validation - catches data corruption"
      }
    },
    {
      "expectation_type": "expect_column_distinct_values_to_be_in_set",
      "kwargs": {
        "column": "cost_type",
        "value_set": ["regular", "tax", "adjustment", "rounding_error", null],
        "mostly": 0.99
      },
      "meta": {
        "description": "Cost type should be one of the known GCP cost types",
        "severity": "info",
        "notes": "Helps identify unexpected cost types from billing export changes"
      }
    },
    {
      "expectation_type": "expect_column_values_to_not_be_null",
      "kwargs": {
        "column": "service_id",
        "mostly": 0.95
      },
      "meta": {
        "description": "Service ID should be populated for 95%+ of records",
        "severity": "warning",
        "notes": "Critical for service-level cost analysis"
      }
    },
    {
      "expectation_type": "expect_column_values_to_not_be_null",
      "kwargs": {
        "column": "project_id",
        "mostly": 0.90
      },
      "meta": {
        "description": "Project ID should be populated for 90%+ of records",
        "severity": "info",
        "notes": "Some costs may be account-level without project association"
      }
    },
    {
      "expectation_type": "expect_column_values_to_be_between",
      "kwargs": {
        "column": "usage_amount",
        "min_value": 0.0,
        "max_value": null,
        "mostly": 0.95
      },
      "meta": {
        "description": "Usage amount should be positive for 95%+ of records",
        "severity": "info",
        "notes": "Usage metrics should generally be positive"
      }
    },
    {
      "expectation_type": "expect_column_values_to_be_between",
      "kwargs": {
        "column": "currency_conversion_rate",
        "min_value": 0.0,
        "max_value": 1000.0,
        "mostly": 0.99
      },
      "meta": {
        "description": "Currency conversion rate should be reasonable (0-1000x)",
        "severity": "warning",
        "notes": "Catches currency conversion anomalies"
      }
    },
    {
      "expectation_type": "expect_column_value_lengths_to_be_between",
      "kwargs": {
        "column": "invoice_month",
        "min_value": 6,
        "max_value": 6,
        "mostly": 0.95
      },
      "meta": {
        "description": "Invoice month should be 6 characters (YYYYMM format)",
        "severity": "info",
        "notes": "Standard GCP invoice month format"
      }
    },
    {
      "expectation_type": "expect_column_mean_to_be_between",
      "kwargs": {
        "column": "cost",
        "min_value": 0.0,
        "max_value": 10000.0
      },
      "meta": {
        "description": "Average cost per record should be reasonable ($0-$10k)",
        "severity": "warning",
        "notes": "Statistical check - extremely high averages indicate anomalies"
      }
    },
    {
      "expectation_type": "expect_column_median_to_be_between",
      "kwargs": {
        "column": "cost",
        "min_value": 0.0,
        "max_value": 100.0
      },
      "meta": {
        "description": "Median cost should be in typical range ($0-$100)",
        "severity": "info",
        "notes": "Statistical check for cost distribution health"
      }
    },
    {
      "expectation_type": "expect_column_quantile_values_to_be_between",
      "kwargs": {
        "column": "cost",
        "quantile_ranges": {
          "quantiles": [0.25, 0.5, 0.75, 0.95, 0.99],
          "value_ranges": [
            [0.0, 10.0],
            [0.0, 100.0],
            [0.0, 500.0],
            [0.0, 5000.0],
            [0.0, 50000.0]
          ]
        },
        "allow_relative_error": true
      },
      "meta": {
        "description": "Cost distribution should follow expected quantile ranges",
        "severity": "info",
        "notes": "Detects shifts in cost distribution - useful for anomaly detection"
      }
    }
  ]
}
