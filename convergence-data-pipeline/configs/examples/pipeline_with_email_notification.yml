# Example Pipeline with Email Notifications
# Demonstrates how to use notify_systems.email_notification processor
# Usage: This pipeline serves as a reference for other pipelines

pipeline_id: "{tenant_id}-example-email-notification"
description: "Example pipeline demonstrating email notifications on pipeline events"

# Pipeline-level variables that can be overridden
variables:
  admin_email: "admin@example.com"
  data_ops_email: "data-ops@example.com"
  alert_email: "alerts@example.com"

steps:
  # Step 1: Example data processing step
  - step_id: "process_data"
    name: "Process Sample Data"
    ps_type: "gcp.bigquery_to_bigquery"
    timeout_minutes: 30

    source:
      bq_project_id: "your-project-id"
      query: |
        SELECT
          'example' AS pipeline_type,
          CURRENT_TIMESTAMP() AS processed_at,
          'demo_data' AS data_source
        LIMIT 100

    destination:
      bq_project_id: "your-project-id"
      dataset_type: "example_dataset"
      table: "processed_data"
      write_mode: "append"

  # Step 2: Send email notification on pipeline failure
  - step_id: "notify_failure_email"
    name: "Email Alert on Failure"
    ps_type: "notify_systems.email_notification"
    trigger: "on_failure"

    # Email recipients
    to_emails:
      - "{admin_email}"
      - "{data_ops_email}"

    # Optional: CC and BCC
    cc_emails:
      - "{alert_email}"

    # Email template
    subject_template: "[ALERT] Pipeline Failed: {pipeline_id}"
    body_template: |
      PIPELINE FAILURE ALERT

      Pipeline ID: {pipeline_id}
      Tenant ID: {tenant_id}
      Triggered By: {trigger_by}
      Failure Time: {execution_timestamp}

      Please check the logs at: {tenant_id}.x_meta_step_logs

      Regards,
      CloudAct Data Platform

  # Step 3: Send email notification on successful completion
  - step_id: "notify_success_email"
    name: "Email Confirmation on Success"
    ps_type: "notify_systems.email_notification"
    trigger: "on_success"

    to_emails:
      - "{admin_email}"

    subject_template: "[SUCCESS] Pipeline Completed: {pipeline_id}"
    body_template: |
      PIPELINE SUCCESS NOTIFICATION

      Pipeline ID: {pipeline_id}
      Tenant ID: {tenant_id}
      Completed At: {execution_timestamp}

      Data has been successfully processed and loaded.

      Regards,
      CloudAct Data Platform

# Pipeline settings
timeout_minutes: 60
max_retries: 1
on_failure_action: "alert"  # Send alerts on failure
