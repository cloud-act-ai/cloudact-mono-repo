# GCP KMS Key Management Pipeline
# Manages KMS encryption/decryption for organization API keys and admin keys
# Usage: POST /api/v1/pipelines/run/{org_slug}/gcp/kms/manage_kms_keys

pipeline_id: "{org_slug}-gcp-kms-key-management"
description: "Manage KMS encryption for {org_slug} - operation: {operation}"

# Pipeline-level variables
variables:
  operation: "validate"  # validate, encrypt, decrypt, rotate, bootstrap
  key_type: "org_api_key"  # org_api_key or ca_root_api_key
  kms_project_id: "gac-prod-471220"
  kms_location: "us-central1"
  kms_keyring: "convergence-keyring-prod"
  kms_key: "api-key-encryption"

steps:
  # Step 1: Validate KMS Configuration
  - step_id: "validate_kms_config"
    name: "Validate KMS Configuration"
    ps_type: "gcp.kms_manager"
    timeout_minutes: 2

    config:
      operation: "validate"
      kms_project_id: "{kms_project_id}"
      kms_location: "{kms_location}"
      kms_keyring: "{kms_keyring}"
      kms_key: "{kms_key}"

    # Skip if operation is not validate
    condition: "{operation} == 'validate' OR {operation} == 'bootstrap'"

  # Step 2: Bootstrap KMS (create keyring and key if not exists)
  - step_id: "bootstrap_kms"
    name: "Bootstrap KMS Setup"
    ps_type: "gcp.kms_manager"
    timeout_minutes: 5
    depends_on:
      - validate_kms_config

    config:
      operation: "bootstrap"
      kms_project_id: "{kms_project_id}"
      kms_location: "{kms_location}"
      kms_keyring: "{kms_keyring}"
      kms_key: "{kms_key}"
      service_account: "convergence-api@{kms_project_id}.iam.gserviceaccount.com"

    # Only run if operation is bootstrap
    condition: "{operation} == 'bootstrap'"

  # Step 3: Encrypt API Keys
  - step_id: "encrypt_api_keys"
    name: "Encrypt API Keys with KMS"
    ps_type: "gcp.kms_manager"
    timeout_minutes: 10

    config:
      operation: "encrypt"
      key_type: "{key_type}"
      kms_project_id: "{kms_project_id}"
      kms_location: "{kms_location}"
      kms_keyring: "{kms_keyring}"
      kms_key: "{kms_key}"

      # Query to get keys to encrypt
      source_query: |
        SELECT
          org_api_key_id,
          org_slug,
          encrypted_org_api_key
        FROM `{kms_project_id}.organizations.org_api_keys`
        WHERE org_slug = @org_slug
        AND is_active = TRUE

    # Only run if operation is encrypt
    condition: "{operation} == 'encrypt'"

  # Step 4: Decrypt API Keys (Admin Only)
  - step_id: "decrypt_api_keys"
    name: "Decrypt API Keys with KMS"
    ps_type: "gcp.kms_manager"
    timeout_minutes: 10

    config:
      operation: "decrypt"
      key_type: "{key_type}"
      kms_project_id: "{kms_project_id}"
      kms_location: "{kms_location}"
      kms_keyring: "{kms_keyring}"
      kms_key: "{kms_key}"
      org_api_key_id: "{org_api_key_id}"  # Specific key to decrypt

    # Only run if operation is decrypt
    condition: "{operation} == 'decrypt'"

  # Step 5: Rotate Encryption Keys
  - step_id: "rotate_encryption"
    name: "Rotate KMS Encryption for Keys"
    ps_type: "gcp.kms_manager"
    timeout_minutes: 30

    config:
      operation: "rotate"
      key_type: "{key_type}"
      kms_project_id: "{kms_project_id}"
      kms_location: "{kms_location}"
      kms_keyring: "{kms_keyring}"
      old_kms_key: "{kms_key}"
      new_kms_key: "{kms_key}-v2"  # New key version

      # Re-encrypt all keys
      batch_size: 100
      max_concurrent: 10

    # Only run if operation is rotate
    condition: "{operation} == 'rotate'"

# Data Quality Checks
data_quality:
  - check_id: "kms_accessibility"
    name: "KMS Key Accessible"
    type: "connectivity"
    severity: "ERROR"
    query: |
      -- Verify KMS key can be accessed
      SELECT 1 AS test_value
    validation: "COUNT(*) = 1"

  - check_id: "encryption_success"
    name: "Encryption Success Rate"
    type: "metric"
    severity: "ERROR"
    threshold: 0.95  # 95% success rate minimum
    description: "At least 95% of keys should encrypt successfully"
