pipeline_name: "{pipeline_id}"
description: "GCP resource inventory for {tenant_id}"

steps:
  - name: "collect_resource_inventory"
    type: "bigquery_query"
    sql: |
      SELECT
        'test-project-' || CAST(MOD(seq, 3) + 1 AS STRING) as project_id,
        CASE
          WHEN MOD(seq, 5) = 0 THEN 'Compute Engine'
          WHEN MOD(seq, 5) = 1 THEN 'Cloud Storage'
          WHEN MOD(seq, 5) = 2 THEN 'BigQuery'
          WHEN MOD(seq, 5) = 3 THEN 'Cloud Pub/Sub'
          ELSE 'Kubernetes Engine'
        END as service_name,
        'resource-type-' || CAST(seq AS STRING) as resource_type,
        CAST(seq * 5 AS INT64) as resource_count,
        CURRENT_TIMESTAMP() as inventory_date
      FROM UNNEST(GENERATE_ARRAY(1, 15)) as seq
      ORDER BY resource_count DESC

    output:
      project_id: "gac-prod-471220"
      dataset: "{tenant_id}"
      table: "gcp_resource_inventory"
      write_disposition: "WRITE_TRUNCATE"
