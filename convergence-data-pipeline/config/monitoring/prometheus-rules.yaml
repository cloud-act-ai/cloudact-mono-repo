# ============================================
# Prometheus Alert Rules
# ============================================
# Alert rules for the Convergence Data Pipeline

groups:
  # ============================================
  # Service Availability Alerts
  # ============================================
  - name: service_availability
    interval: 30s
    rules:
      - alert: ServiceDown
        expr: up{job="convergence-api"} == 0
        for: 1m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "Service {{ $labels.instance }} is down"
          description: "The convergence-api service has been down for more than 1 minute."
          runbook_url: "https://docs.cloudact.io/runbooks/service-down"

      - alert: HighErrorRate
        expr: |
          sum(rate(http_requests_total{status_code=~"5.."}[5m])) /
          sum(rate(http_requests_total[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
          runbook_url: "https://docs.cloudact.io/runbooks/high-error-rate"

      - alert: AvailabilitySLOBreach
        expr: |
          (
            sum(rate(http_requests_total{status_code!~"5.."}[30d])) /
            sum(rate(http_requests_total[30d]))
          ) < 0.999
        for: 1h
        labels:
          severity: high
          component: slo
        annotations:
          summary: "Availability SLO breach (99.9%)"
          description: "30-day availability is {{ $value | humanizePercentage }}"
          runbook_url: "https://docs.cloudact.io/runbooks/slo-breach"

  # ============================================
  # Performance Alerts
  # ============================================
  - name: performance
    interval: 30s
    rules:
      - alert: HighLatencyP95
        expr: |
          histogram_quantile(0.95,
            rate(http_request_duration_seconds_bucket[5m])
          ) > 1.0
        for: 10m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "High latency detected (P95)"
          description: "P95 latency is {{ $value | humanizeDuration }} (threshold: 1s)"
          runbook_url: "https://docs.cloudact.io/runbooks/high-latency"

      - alert: HighLatencyP99
        expr: |
          histogram_quantile(0.99,
            rate(http_request_duration_seconds_bucket[5m])
          ) > 2.5
        for: 10m
        labels:
          severity: high
          component: api
        annotations:
          summary: "Very high latency detected (P99)"
          description: "P99 latency is {{ $value | humanizeDuration }} (threshold: 2.5s)"
          runbook_url: "https://docs.cloudact.io/runbooks/high-latency"

      - alert: LatencySLOBreach
        expr: |
          histogram_quantile(0.95,
            rate(http_request_duration_seconds_bucket[30d])
          ) > 0.5
        for: 1h
        labels:
          severity: high
          component: slo
        annotations:
          summary: "Latency SLO breach (P95 < 500ms)"
          description: "30-day P95 latency is {{ $value | humanizeDuration }}"
          runbook_url: "https://docs.cloudact.io/runbooks/slo-breach"

  # ============================================
  # Pipeline Alerts
  # ============================================
  - name: pipeline
    interval: 1m
    rules:
      - alert: PipelineFailureRate
        expr: |
          sum(rate(pipeline_executions_total{status="failed"}[15m])) /
          sum(rate(pipeline_executions_total[15m])) > 0.1
        for: 5m
        labels:
          severity: high
          component: pipeline
        annotations:
          summary: "High pipeline failure rate"
          description: "Pipeline failure rate is {{ $value | humanizePercentage }} (threshold: 10%)"
          runbook_url: "https://docs.cloudact.io/runbooks/pipeline-failures"

      - alert: PipelineDurationExceeded
        expr: |
          histogram_quantile(0.95,
            rate(pipeline_execution_duration_seconds_bucket[15m])
          ) > 1800
        for: 15m
        labels:
          severity: warning
          component: pipeline
        annotations:
          summary: "Pipeline execution time is high"
          description: "P95 pipeline duration is {{ $value | humanizeDuration }} (threshold: 30m)"
          runbook_url: "https://docs.cloudact.io/runbooks/slow-pipelines"

      - alert: PipelineStuck
        expr: |
          time() - max(pipeline_execution_last_success_timestamp) > 7200
        for: 30m
        labels:
          severity: high
          component: pipeline
        annotations:
          summary: "No successful pipeline executions"
          description: "No successful pipeline executions for {{ $value | humanizeDuration }}"
          runbook_url: "https://docs.cloudact.io/runbooks/pipeline-stuck"

      - alert: PipelineRetryRateHigh
        expr: |
          sum(rate(pipeline_retries_total[10m])) > 5
        for: 10m
        labels:
          severity: warning
          component: pipeline
        annotations:
          summary: "High pipeline retry rate"
          description: "Pipeline retry rate is {{ $value }} retries/sec"
          runbook_url: "https://docs.cloudact.io/runbooks/pipeline-retries"

  # ============================================
  # Authentication & Security Alerts
  # ============================================
  - name: security
    interval: 30s
    rules:
      - alert: HighAuthFailureRate
        expr: |
          sum(rate(auth_failures_total[5m])) > 5
        for: 2m
        labels:
          severity: high
          component: security
        annotations:
          summary: "High authentication failure rate"
          description: "Auth failure rate is {{ $value }} failures/sec (threshold: 5/min)"
          runbook_url: "https://docs.cloudact.io/runbooks/auth-failures"

      - alert: PotentialBruteForce
        expr: |
          sum by (tenant_id) (
            rate(auth_failures_total[1m])
          ) > 10
        for: 1m
        labels:
          severity: critical
          component: security
        annotations:
          summary: "Potential brute force attack on tenant {{ $labels.tenant_id }}"
          description: "{{ $value }} failed auth attempts per second for tenant {{ $labels.tenant_id }}"
          runbook_url: "https://docs.cloudact.io/runbooks/brute-force"

      - alert: RateLimitHitsHigh
        expr: |
          sum(rate(rate_limit_hits_total[5m])) > 10
        for: 5m
        labels:
          severity: medium
          component: rate_limiting
        annotations:
          summary: "High rate limit hit rate"
          description: "Rate limit hit rate is {{ $value }} hits/sec"
          runbook_url: "https://docs.cloudact.io/runbooks/rate-limits"

  # ============================================
  # BigQuery Alerts
  # ============================================
  - name: bigquery
    interval: 1m
    rules:
      - alert: BigQueryErrorRate
        expr: |
          sum(rate(bigquery_errors_total[10m])) /
          sum(rate(bigquery_queries_total[10m])) > 0.05
        for: 5m
        labels:
          severity: high
          component: bigquery
        annotations:
          summary: "High BigQuery error rate"
          description: "BigQuery error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
          runbook_url: "https://docs.cloudact.io/runbooks/bigquery-errors"

      - alert: BigQuerySlowQueries
        expr: |
          histogram_quantile(0.95,
            rate(bigquery_query_duration_seconds_bucket[10m])
          ) > 30
        for: 10m
        labels:
          severity: warning
          component: bigquery
        annotations:
          summary: "Slow BigQuery queries detected"
          description: "P95 query duration is {{ $value | humanizeDuration }} (threshold: 30s)"
          runbook_url: "https://docs.cloudact.io/runbooks/slow-queries"

      - alert: BigQueryQuotaExceeded
        expr: |
          bigquery_quota_used_percent > 80
        for: 5m
        labels:
          severity: warning
          component: bigquery
        annotations:
          summary: "BigQuery quota usage high"
          description: "BigQuery quota usage is {{ $value }}% (threshold: 80%)"
          runbook_url: "https://docs.cloudact.io/runbooks/quota-exceeded"

  # ============================================
  # System Resource Alerts
  # ============================================
  - name: system_resources
    interval: 30s
    rules:
      - alert: HighCPUUsage
        expr: system_cpu_usage_percent > 80
        for: 10m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ $value }}% (threshold: 80%)"
          runbook_url: "https://docs.cloudact.io/runbooks/high-cpu"

      - alert: CriticalCPUUsage
        expr: system_cpu_usage_percent > 95
        for: 5m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Critical CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ $value }}% (threshold: 95%)"
          runbook_url: "https://docs.cloudact.io/runbooks/high-cpu"

      - alert: HighMemoryUsage
        expr: |
          (system_memory_usage_bytes / system_memory_total_bytes) * 100 > 85
        for: 10m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is {{ $value }}% (threshold: 85%)"
          runbook_url: "https://docs.cloudact.io/runbooks/high-memory"

      - alert: CriticalMemoryUsage
        expr: |
          (system_memory_usage_bytes / system_memory_total_bytes) * 100 > 95
        for: 5m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Critical memory usage on {{ $labels.instance }}"
          description: "Memory usage is {{ $value }}% (threshold: 95%)"
          runbook_url: "https://docs.cloudact.io/runbooks/high-memory"

      - alert: HighDiskUsage
        expr: |
          (system_disk_usage_bytes / system_disk_total_bytes) * 100 > 85
        for: 10m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High disk usage on {{ $labels.instance }}"
          description: "Disk usage is {{ $value }}% (threshold: 85%)"
          runbook_url: "https://docs.cloudact.io/runbooks/high-disk"

  # ============================================
  # Metadata Logging Alerts
  # ============================================
  - name: metadata_logging
    interval: 30s
    rules:
      - alert: MetadataLogQueueFull
        expr: metadata_log_queue_size > 900
        for: 5m
        labels:
          severity: high
          component: metadata
        annotations:
          summary: "Metadata log queue near capacity"
          description: "Queue size is {{ $value }} (threshold: 900/1000)"
          runbook_url: "https://docs.cloudact.io/runbooks/metadata-queue-full"

      - alert: MetadataLogFlushFailures
        expr: |
          sum(rate(metadata_log_flush_errors_total[5m])) > 0.1
        for: 5m
        labels:
          severity: high
          component: metadata
        annotations:
          summary: "Metadata log flush failures detected"
          description: "Flush failure rate is {{ $value }} failures/sec"
          runbook_url: "https://docs.cloudact.io/runbooks/metadata-flush-failures"

      - alert: MetadataLogLatency
        expr: |
          histogram_quantile(0.95,
            rate(metadata_log_flush_duration_seconds_bucket[10m])
          ) > 10
        for: 10m
        labels:
          severity: warning
          component: metadata
        annotations:
          summary: "High metadata log flush latency"
          description: "P95 flush latency is {{ $value | humanizeDuration }} (threshold: 10s)"
          runbook_url: "https://docs.cloudact.io/runbooks/metadata-latency"

  # ============================================
  # Connection & Network Alerts
  # ============================================
  - name: connections
    interval: 30s
    rules:
      - alert: HighConnectionCount
        expr: active_connections > 1000
        for: 5m
        labels:
          severity: warning
          component: network
        annotations:
          summary: "High active connection count"
          description: "Active connections: {{ $value }} (threshold: 1000)"
          runbook_url: "https://docs.cloudact.io/runbooks/high-connections"

      - alert: ConnectionsGrowing
        expr: |
          deriv(active_connections[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: network
        annotations:
          summary: "Connection count growing rapidly"
          description: "Connection growth rate: {{ $value }} connections/sec"
          runbook_url: "https://docs.cloudact.io/runbooks/connection-growth"

  # ============================================
  # Tenant-Specific Alerts
  # ============================================
  - name: tenant_metrics
    interval: 1m
    rules:
      - alert: TenantQuotaExceeded
        expr: |
          sum by (tenant_id) (
            rate(http_requests_total[1h])
          ) > 1000
        for: 10m
        labels:
          severity: medium
          component: quota
        annotations:
          summary: "Tenant {{ $labels.tenant_id }} exceeded hourly quota"
          description: "Request rate: {{ $value }} req/sec for tenant {{ $labels.tenant_id }}"
          runbook_url: "https://docs.cloudact.io/runbooks/quota-exceeded"

      - alert: TenantPipelineFailures
        expr: |
          sum by (tenant_id) (
            rate(pipeline_executions_total{status="failed"}[15m])
          ) /
          sum by (tenant_id) (
            rate(pipeline_executions_total[15m])
          ) > 0.2
        for: 10m
        labels:
          severity: medium
          component: pipeline
        annotations:
          summary: "High failure rate for tenant {{ $labels.tenant_id }}"
          description: "Failure rate: {{ $value | humanizePercentage }} for tenant {{ $labels.tenant_id }}"
          runbook_url: "https://docs.cloudact.io/runbooks/tenant-pipeline-failures"
