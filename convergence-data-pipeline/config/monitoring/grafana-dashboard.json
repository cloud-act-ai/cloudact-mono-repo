{
  "dashboard": {
    "title": "Convergence Data Pipeline - Production Metrics",
    "tags": ["convergence", "pipeline", "production"],
    "timezone": "UTC",
    "editable": true,
    "graphTooltip": 1,
    "time": {
      "from": "now-6h",
      "to": "now"
    },
    "refresh": "30s",
    "panels": [
      {
        "id": 1,
        "title": "System Overview",
        "type": "row",
        "gridPos": {"x": 0, "y": 0, "w": 24, "h": 1}
      },
      {
        "id": 2,
        "title": "Request Rate (req/s)",
        "type": "graph",
        "gridPos": {"x": 0, "y": 1, "w": 8, "h": 8},
        "targets": [
          {
            "expr": "sum(rate(http_requests_total[5m]))",
            "legendFormat": "Total",
            "refId": "A"
          },
          {
            "expr": "sum(rate(http_requests_total{status_code=~\"2..\"}[5m]))",
            "legendFormat": "2xx Success",
            "refId": "B"
          },
          {
            "expr": "sum(rate(http_requests_total{status_code=~\"4..\"}[5m]))",
            "legendFormat": "4xx Client Error",
            "refId": "C"
          },
          {
            "expr": "sum(rate(http_requests_total{status_code=~\"5..\"}[5m]))",
            "legendFormat": "5xx Server Error",
            "refId": "D"
          }
        ],
        "yaxes": [
          {"format": "reqps", "label": "Requests/sec"},
          {"format": "short"}
        ]
      },
      {
        "id": 3,
        "title": "Error Rate (%)",
        "type": "graph",
        "gridPos": {"x": 8, "y": 1, "w": 8, "h": 8},
        "targets": [
          {
            "expr": "sum(rate(http_requests_total{status_code=~\"5..\"}[5m])) / sum(rate(http_requests_total[5m])) * 100",
            "legendFormat": "5xx Error Rate",
            "refId": "A"
          }
        ],
        "yaxes": [
          {"format": "percent", "label": "Error %", "max": 100},
          {"format": "short"}
        ],
        "alert": {
          "conditions": [
            {
              "evaluator": {"params": [5], "type": "gt"},
              "query": {"params": ["A", "5m", "now"]},
              "type": "query"
            }
          ],
          "name": "High Error Rate Alert"
        }
      },
      {
        "id": 4,
        "title": "Request Latency (P50, P95, P99)",
        "type": "graph",
        "gridPos": {"x": 16, "y": 1, "w": 8, "h": 8},
        "targets": [
          {
            "expr": "histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))",
            "legendFormat": "P50",
            "refId": "A"
          },
          {
            "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))",
            "legendFormat": "P95",
            "refId": "B"
          },
          {
            "expr": "histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))",
            "legendFormat": "P99",
            "refId": "C"
          }
        ],
        "yaxes": [
          {"format": "s", "label": "Duration"},
          {"format": "short"}
        ]
      },
      {
        "id": 10,
        "title": "Pipeline Metrics",
        "type": "row",
        "gridPos": {"x": 0, "y": 9, "w": 24, "h": 1}
      },
      {
        "id": 11,
        "title": "Pipeline Execution Rate",
        "type": "graph",
        "gridPos": {"x": 0, "y": 10, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "sum(rate(pipeline_executions_total[5m]))",
            "legendFormat": "Total Executions",
            "refId": "A"
          },
          {
            "expr": "sum(rate(pipeline_executions_total{status=\"success\"}[5m]))",
            "legendFormat": "Successful",
            "refId": "B"
          },
          {
            "expr": "sum(rate(pipeline_executions_total{status=\"failed\"}[5m]))",
            "legendFormat": "Failed",
            "refId": "C"
          }
        ],
        "yaxes": [
          {"format": "ops", "label": "Executions/sec"},
          {"format": "short"}
        ]
      },
      {
        "id": 12,
        "title": "Pipeline Success Rate (%)",
        "type": "singlestat",
        "gridPos": {"x": 12, "y": 10, "w": 6, "h": 8},
        "targets": [
          {
            "expr": "sum(rate(pipeline_executions_total{status=\"success\"}[5m])) / sum(rate(pipeline_executions_total[5m])) * 100",
            "refId": "A"
          }
        ],
        "format": "percent",
        "gauge": {
          "show": true,
          "minValue": 0,
          "maxValue": 100,
          "thresholdMarkers": true
        },
        "thresholds": "80,95"
      },
      {
        "id": 13,
        "title": "Pipeline Duration (P95)",
        "type": "graph",
        "gridPos": {"x": 18, "y": 10, "w": 6, "h": 8},
        "targets": [
          {
            "expr": "histogram_quantile(0.95, sum(rate(pipeline_execution_duration_seconds_bucket[5m])) by (le))",
            "legendFormat": "P95 Duration",
            "refId": "A"
          }
        ],
        "yaxes": [
          {"format": "s", "label": "Duration"},
          {"format": "short"}
        ]
      },
      {
        "id": 20,
        "title": "BigQuery Metrics",
        "type": "row",
        "gridPos": {"x": 0, "y": 18, "w": 24, "h": 1}
      },
      {
        "id": 21,
        "title": "BigQuery Query Rate",
        "type": "graph",
        "gridPos": {"x": 0, "y": 19, "w": 8, "h": 8},
        "targets": [
          {
            "expr": "sum(rate(bigquery_queries_total[5m]))",
            "legendFormat": "Query Rate",
            "refId": "A"
          }
        ],
        "yaxes": [
          {"format": "qps", "label": "Queries/sec"},
          {"format": "short"}
        ]
      },
      {
        "id": 22,
        "title": "BigQuery Query Duration (P95)",
        "type": "graph",
        "gridPos": {"x": 8, "y": 19, "w": 8, "h": 8},
        "targets": [
          {
            "expr": "histogram_quantile(0.95, sum(rate(bigquery_query_duration_seconds_bucket[5m])) by (le))",
            "legendFormat": "P95 Duration",
            "refId": "A"
          }
        ],
        "yaxes": [
          {"format": "s", "label": "Duration"},
          {"format": "short"}
        ]
      },
      {
        "id": 23,
        "title": "BigQuery Bytes Processed",
        "type": "graph",
        "gridPos": {"x": 16, "y": 19, "w": 8, "h": 8},
        "targets": [
          {
            "expr": "sum(rate(bigquery_bytes_processed_total[5m]))",
            "legendFormat": "Bytes/sec",
            "refId": "A"
          }
        ],
        "yaxes": [
          {"format": "Bps", "label": "Bytes/sec"},
          {"format": "short"}
        ]
      },
      {
        "id": 30,
        "title": "System Resources",
        "type": "row",
        "gridPos": {"x": 0, "y": 27, "w": 24, "h": 1}
      },
      {
        "id": 31,
        "title": "CPU Usage (%)",
        "type": "graph",
        "gridPos": {"x": 0, "y": 28, "w": 8, "h": 8},
        "targets": [
          {
            "expr": "system_cpu_usage_percent",
            "legendFormat": "CPU %",
            "refId": "A"
          }
        ],
        "yaxes": [
          {"format": "percent", "label": "CPU %", "max": 100},
          {"format": "short"}
        ],
        "thresholds": [
          {"value": 80, "colorMode": "critical"}
        ]
      },
      {
        "id": 32,
        "title": "Memory Usage (%)",
        "type": "graph",
        "gridPos": {"x": 8, "y": 28, "w": 8, "h": 8},
        "targets": [
          {
            "expr": "(system_memory_usage_bytes / system_memory_total_bytes) * 100",
            "legendFormat": "Memory %",
            "refId": "A"
          }
        ],
        "yaxes": [
          {"format": "percent", "label": "Memory %", "max": 100},
          {"format": "short"}
        ],
        "thresholds": [
          {"value": 85, "colorMode": "critical"}
        ]
      },
      {
        "id": 33,
        "title": "Active Connections",
        "type": "graph",
        "gridPos": {"x": 16, "y": 28, "w": 8, "h": 8},
        "targets": [
          {
            "expr": "active_connections",
            "legendFormat": "Connections",
            "refId": "A"
          }
        ],
        "yaxes": [
          {"format": "short", "label": "Connections"},
          {"format": "short"}
        ]
      },
      {
        "id": 40,
        "title": "Security & Rate Limiting",
        "type": "row",
        "gridPos": {"x": 0, "y": 36, "w": 24, "h": 1}
      },
      {
        "id": 41,
        "title": "Authentication Failures",
        "type": "graph",
        "gridPos": {"x": 0, "y": 37, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "sum(rate(auth_failures_total[5m]))",
            "legendFormat": "Auth Failures/sec",
            "refId": "A"
          }
        ],
        "yaxes": [
          {"format": "ops", "label": "Failures/sec"},
          {"format": "short"}
        ]
      },
      {
        "id": 42,
        "title": "Rate Limit Hits",
        "type": "graph",
        "gridPos": {"x": 12, "y": 37, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "sum(rate(rate_limit_hits_total[5m]))",
            "legendFormat": "Rate Limit Hits/sec",
            "refId": "A"
          }
        ],
        "yaxes": [
          {"format": "ops", "label": "Hits/sec"},
          {"format": "short"}
        ]
      },
      {
        "id": 50,
        "title": "Metadata Logging",
        "type": "row",
        "gridPos": {"x": 0, "y": 45, "w": 24, "h": 1}
      },
      {
        "id": 51,
        "title": "Metadata Log Queue Size",
        "type": "graph",
        "gridPos": {"x": 0, "y": 46, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "metadata_log_queue_size",
            "legendFormat": "Queue Size",
            "refId": "A"
          }
        ],
        "yaxes": [
          {"format": "short", "label": "Queue Size", "max": 1000},
          {"format": "short"}
        ],
        "thresholds": [
          {"value": 900, "colorMode": "critical"}
        ]
      },
      {
        "id": 52,
        "title": "Metadata Logs Written",
        "type": "graph",
        "gridPos": {"x": 12, "y": 46, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "sum(rate(metadata_logs_total[5m]))",
            "legendFormat": "Logs/sec",
            "refId": "A"
          }
        ],
        "yaxes": [
          {"format": "ops", "label": "Logs/sec"},
          {"format": "short"}
        ]
      }
    ],
    "templating": {
      "list": [
        {
          "name": "environment",
          "type": "query",
          "query": "label_values(environment)",
          "current": {"value": "production"}
        },
        {
          "name": "tenant",
          "type": "query",
          "query": "label_values(tenant_id)",
          "multi": true,
          "includeAll": true
        }
      ]
    },
    "annotations": {
      "list": [
        {
          "name": "Deployments",
          "datasource": "Prometheus",
          "enable": true,
          "iconColor": "blue",
          "tags": ["deployment"]
        },
        {
          "name": "Incidents",
          "datasource": "Prometheus",
          "enable": true,
          "iconColor": "red",
          "tags": ["incident"]
        }
      ]
    }
  }
}
