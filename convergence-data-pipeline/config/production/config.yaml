# ============================================
# Convergence Data Pipeline - Production Configuration
# ============================================
# Feature flags, rate limits, quotas, and operational settings

application:
  name: convergence-data-pipeline
  version: 1.0.0
  environment: production

  # Feature flags
  features:
    distributed_tracing: true
    metrics_collection: true
    rate_limiting: true
    request_validation: true
    sql_injection_protection: true
    kms_encryption: true
    notifications: true
    async_pipeline_execution: true
    pub_sub_integration: true
    graceful_shutdown: true

  # Performance tuning
  performance:
    # Uvicorn workers (should be 2x CPU cores)
    api_workers: 4

    # Maximum concurrent pipeline executions
    max_concurrent_pipelines: 10

    # Metadata logging workers
    metadata_log_workers: 5
    metadata_log_queue_size: 1000
    metadata_log_batch_size: 100
    metadata_log_flush_interval_seconds: 5

    # Pipeline parallel processing
    pipeline_max_parallel_steps: 10
    pipeline_partition_batch_size: 10

    # Polars configuration
    polars_max_threads: 8
    polars_streaming_chunk_size: 100000

    # BigQuery configuration
    bq_max_results_per_page: 10000
    bq_query_timeout_seconds: 300
    bq_max_retry_attempts: 3

# ============================================
# Rate Limiting Configuration
# ============================================
rate_limiting:
  enabled: true

  # Per-tenant limits
  tenant:
    requests_per_minute: 100
    requests_per_hour: 1000
    pipeline_concurrency: 5

  # Global limits (all tenants combined)
  global:
    requests_per_minute: 10000
    requests_per_hour: 100000

  # Endpoint-specific limits
  endpoints:
    # Expensive admin operations
    admin_tenants:
      requests_per_minute: 10
      description: "Rate limit for /admin/tenants endpoint"

    # Pipeline execution
    pipeline_run:
      requests_per_minute: 50
      description: "Rate limit for /pipelines/run/* endpoints"

    # Pipeline creation
    pipeline_create:
      requests_per_minute: 20
      description: "Rate limit for pipeline creation endpoints"

# ============================================
# Security Configuration
# ============================================
security:
  # Authentication
  auth:
    enabled: true
    algorithm: HS256
    token_expiry_hours: 24

  # CORS settings
  cors:
    enabled: true
    allowed_origins:
      - "https://app.cloudact.io"
      - "https://console.cloudact.io"
    allow_credentials: true
    allowed_methods:
      - GET
      - POST
      - PUT
      - DELETE
      - PATCH
    allowed_headers:
      - "*"
    max_age: 3600

  # Request validation
  validation:
    max_request_size_bytes: 10485760  # 10 MB
    max_header_size_bytes: 8192       # 8 KB
    tenant_id_pattern: "^[a-zA-Z0-9_-]+$"
    pipeline_id_pattern: "^[a-zA-Z0-9_-]+$"

  # Content Security Policy
  csp:
    enabled: true
    directives:
      default-src: "'self'"
      script-src: "'self' 'unsafe-inline'"
      style-src: "'self' 'unsafe-inline'"
      img-src: "'self' data: https:"
      font-src: "'self' data:"
      connect-src: "'self'"
      frame-ancestors: "'none'"

  # KMS Encryption
  kms:
    enabled: true
    project_id: "${GCP_PROJECT_ID}"
    location: "us-central1"
    keyring: "convergence-keyring"
    key: "convergence-encryption-key"

# ============================================
# Quotas and Limits
# ============================================
quotas:
  # Per-tenant quotas
  tenant:
    max_pipelines: 100
    max_api_keys: 10
    max_schedules: 50
    max_notifications: 20

    # Data processing limits
    max_rows_per_pipeline: 10000000  # 10M rows
    max_pipeline_duration_minutes: 60
    max_pipeline_retries: 3

  # Global quotas
  global:
    max_total_tenants: 10000
    max_concurrent_executions: 100
    max_daily_pipeline_runs: 100000

# ============================================
# Data Quality Configuration
# ============================================
data_quality:
  enabled: true
  fail_on_error: false
  store_results_in_bq: true

  # Validation rules
  rules:
    - name: row_count_check
      enabled: true
      min_rows: 1

    - name: null_check
      enabled: true
      max_null_percentage: 5.0

    - name: schema_validation
      enabled: true
      strict_mode: false

# ============================================
# Notification Configuration
# ============================================
notifications:
  enabled: true

  # Default notification triggers
  triggers:
    pipeline_success: false
    pipeline_failure: true
    pipeline_warning: true
    system_error: true

  # Retry configuration
  retry:
    max_attempts: 3
    backoff_seconds: 5

  # Rate limiting for notifications
  rate_limit:
    max_per_hour: 50
    max_per_day: 200

# ============================================
# Observability Configuration
# ============================================
observability:
  # Logging
  logging:
    level: INFO
    format: json
    structured: true

    # Log retention
    retention_days: 30

    # Additional context
    include_request_id: true
    include_tenant_id: true
    include_trace_id: true

  # Metrics
  metrics:
    enabled: true
    export_interval_seconds: 60

    # Prometheus configuration
    prometheus:
      enabled: true
      port: 9090
      path: /metrics

  # Tracing
  tracing:
    enabled: true
    sample_rate: 0.1  # 10% sampling in production

    # OpenTelemetry configuration
    otlp:
      endpoint: "${OTEL_EXPORTER_OTLP_ENDPOINT}"
      service_name: convergence-api

# ============================================
# Distributed Lock Configuration
# ============================================
distributed_lock:
  backend: firestore  # 'memory' or 'firestore'
  timeout_seconds: 3600  # 1 hour
  collection: pipeline_locks

  # Auto-cleanup of stale locks
  cleanup:
    enabled: true
    interval_minutes: 15
    max_lock_age_hours: 2

# ============================================
# Graceful Shutdown Configuration
# ============================================
graceful_shutdown:
  enabled: true
  timeout_seconds: 30

  # Shutdown hooks
  hooks:
    flush_metadata_logs: true
    close_db_connections: true
    complete_running_pipelines: true
    reject_new_requests: true

# ============================================
# Health Check Configuration
# ============================================
health_checks:
  # Liveness probe
  liveness:
    enabled: true
    path: /health/live
    interval_seconds: 10

  # Readiness probe
  readiness:
    enabled: true
    path: /health/ready
    interval_seconds: 30
    timeout_seconds: 5

    # Dependencies to check
    checks:
      - bigquery
      - firestore
      - secrets_manager

# ============================================
# Backup and Recovery Configuration
# ============================================
backup:
  # Metadata backup
  metadata:
    enabled: true
    schedule: "0 2 * * *"  # Daily at 2 AM
    retention_days: 30

  # Configuration backup
  config:
    enabled: true
    schedule: "0 3 * * *"  # Daily at 3 AM
    retention_days: 30

# ============================================
# Compliance and Audit Configuration
# ============================================
compliance:
  # Audit logging
  audit:
    enabled: true
    log_all_requests: true
    log_auth_events: true
    log_data_access: true
    retention_days: 90

  # Data retention policies
  retention:
    pipeline_logs: 90
    api_keys: 365
    execution_history: 180

  # PII handling
  pii:
    mask_sensitive_data: true
    encrypt_at_rest: true
    encrypt_in_transit: true
