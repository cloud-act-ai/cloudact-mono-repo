# Demo Account Setup

Automated scripts for setting up, managing, and cleaning up demo accounts with full cost data across all categories (GenAI, Cloud, SaaS Subscriptions).

## Quick Start

```bash
cd 01-fronted-system
source .env.local

# 0. Cleanup existing demo account (if re-creating)
npx tsx tests/demo-setup/cleanup-demo-account.ts --email=john@example.com

# 1. Create demo account via Playwright (includes Stripe checkout)
npx tsx tests/demo-setup/setup-demo-account.ts
# → Returns org_slug and apiKey

# 2. Set environment variables (use values from step 1)
export ORG_SLUG="acme_inc_01032026"  # Use actual slug from step 1
export ORG_API_KEY="..."              # Use actual key from step 1

# 3. Load demo data + run pipelines
npx tsx tests/demo-setup/load-demo-data-direct.ts --org-slug=$ORG_SLUG --api-key=$ORG_API_KEY

# 4. Verify
curl -s "http://localhost:8000/api/v1/costs/${ORG_SLUG}/total" -H "X-API-Key: $ORG_API_KEY" | jq
```

## Demo Account Values

| Field | Value | Notes |
|-------|-------|-------|
| Email | `john@example.com` | Default demo user |
| Password | `acme1234` | Default password |
| First Name | `John` | |
| Last Name | `Doe` | |
| Phone | `5551234567` | |
| Company | `Acme Inc` | **DO NOT add date suffix** |
| Company Type | `Company` | |
| Currency | `$ USD` | |
| Timezone | `PST/PDT - Los Angeles, USA` | |
| Plan | `scale` | Free trial, no credit card required |
| **Org Slug** | `acme_inc_MMDDYYYY` | **Auto-generated by backend** (e.g., `acme_inc_01032026`) |

## Scripts Overview

| Script | Purpose | When to Use |
|--------|---------|-------------|
| `cleanup-demo-account.ts` | Delete user + org from Supabase + BigQuery | Step 0: Before re-creating demo account |
| `setup-demo-account.ts` | Create account via Playwright (Stripe included) | Step 1: Create user, org, complete checkout |
| `load-demo-data-direct.ts` | Load raw data + run pipelines | Step 2: Load data and calculate costs |

## Complete Workflow

### Step 0: Cleanup (If Re-creating)

Delete existing demo user and datasets before re-creating.

```bash
cd 01-fronted-system
source .env.local

# By email
npx tsx tests/demo-setup/cleanup-demo-account.ts --email=john@example.com

# OR by org slug
npx tsx tests/demo-setup/cleanup-demo-account.ts --org-slug=acme_inc_01022026
```

**Deletes:**
- Supabase: auth.users, profiles, organization_members, organizations, invites
- BigQuery: `{org_slug}_local` dataset

### Step 1: Create Demo Account (Playwright)

**ALWAYS use Playwright** for account creation. This automates:
1. Signup form (account + organization details)
2. Plan selection (Scale)
3. Stripe checkout ("Start trial" - no credit card)
4. Dashboard redirect
5. API key retrieval

```bash
npx tsx tests/demo-setup/setup-demo-account.ts
```

**Options:**
| Option | Description | Default |
|--------|-------------|---------|
| `--email=` | Account email | `john@example.com` |
| `--password=` | Account password | `acme1234` |
| `--company=` | Company name | `Acme Inc` |
| `--plan=` | starter/professional/scale | `scale` |

**Output:**
```json
{
  "success": true,
  "message": "Demo account created and onboarding completed!",
  "orgSlug": "acme_inc_01032026",
  "apiKey": "org_api_key_...",
  "dashboardUrl": "http://localhost:3000/acme_inc_01032026/dashboard"
}
```

**Environment Variables:**
| Variable | Description | Default |
|----------|-------------|---------|
| `TEST_BASE_URL` | Frontend URL | `http://localhost:3000` |
| `TEST_HEADLESS` | Run headless | `true` |
| `TEST_SLOW_MO` | Slow down (ms) | `0` |
| `CA_ROOT_API_KEY` | Root key for API key fetch | From `.env.local` |

### Step 2: Load Demo Data

Two-stage data loading process:

**Stage 1: Load Raw Data (bq CLI)**
- GenAI pricing seed → `genai_payg_pricing`
- GenAI usage raw → `genai_payg_usage_raw`
- Cloud billing raw → `cloud_*_billing_raw_daily`
- Subscription plans → `subscription_plans`

**Stage 2: Run Pipelines (Pipeline Service API)**
- Sync stored procedures
- Subscription cost pipeline
- GenAI consolidation pipeline
- Cloud FOCUS conversion pipeline

```bash
# Full mode (Stage 1 + Stage 2)
npx tsx tests/demo-setup/load-demo-data-direct.ts \
  --org-slug=$ORG_SLUG \
  --api-key=$ORG_API_KEY

# Stage 1 only (raw data)
npx tsx tests/demo-setup/load-demo-data-direct.ts \
  --org-slug=$ORG_SLUG \
  --api-key=$ORG_API_KEY \
  --raw-only

# Stage 2 only (pipelines)
npx tsx tests/demo-setup/load-demo-data-direct.ts \
  --org-slug=$ORG_SLUG \
  --api-key=$ORG_API_KEY \
  --pipelines-only
```

**Options:**
| Option | Description |
|--------|-------------|
| `--org-slug=` | Organization slug (required) |
| `--api-key=` | Organization API key (required) |
| `--raw-only` | Only load raw data, skip pipelines |
| `--pipelines-only` | Only run pipelines, skip raw data |
| `--start-date=` | Start date (default: 2025-01-01) |
| `--end-date=` | End date (default: 2026-01-02) |

### Step 3: Verify

```bash
# Check total costs via API
curl -s "http://localhost:8000/api/v1/costs/${ORG_SLUG}/total" \
  -H "X-API-Key: $ORG_API_KEY" | jq

# Expected output:
# GenAI: ~$1.4M
# Cloud: ~$1.4M
# SaaS: ~$77K
```

**Dashboard URL:** `http://localhost:3000/${ORG_SLUG}/dashboard`
**Login:** `john@example.com` / `acme1234`

## Environment Configuration

### Environment Variables (from .env.local)

```bash
CA_ROOT_API_KEY=test-ca-root-key-dev-32chars
GCP_PROJECT_ID=cloudact-testing-1
SUPABASE_SERVICE_ROLE_KEY=eyJhbG...
NEXT_PUBLIC_SUPABASE_URL=https://kwroaccbrxppfiysqlzs.supabase.co
```

**Load environment:**
```bash
source .env.local
```

### Service URLs

| Environment | Frontend | API Service | Pipeline Service |
|-------------|----------|-------------|------------------|
| **local** | `http://localhost:3000` | `http://localhost:8000` | `http://localhost:8001` |
| **stage** | `https://cloudact-stage.vercel.app` | Cloud Run | Cloud Run |
| **prod** | `https://cloudact.ai` | `https://api.cloudact.ai` | `https://pipeline.cloudact.ai` |

## API Key

**API key is created during backend onboarding** - you just need to fetch it:

```bash
export CA_ROOT_API_KEY=$(grep CA_ROOT_API_KEY .env.local | cut -d'=' -f2)

export ORG_API_KEY=$(curl -s "http://localhost:8000/api/v1/admin/dev/api-key/${ORG_SLUG}" \
  -H "X-CA-Root-Key: $CA_ROOT_API_KEY" | jq -r '.api_key')

echo "ORG_API_KEY: $ORG_API_KEY"
```

**Note:** The Playwright script automatically fetches the API key after account creation.

## Troubleshooting

| Issue | Cause | Solution |
|-------|-------|----------|
| Signup 400 error | Email confirmation enabled | Disable in Supabase Auth settings |
| Account already exists | User exists | Run cleanup script first |
| Stripe checkout hangs | Test mode requires click | Script auto-clicks "Start trial" |
| API returns 401 | Invalid API key | Check key with dev endpoint |
| Dashboard shows $0 | Pipelines not run or wrong date range | Select Dec 2025 date range |
| Missing CA_ROOT_API_KEY | Env not loaded | Run `source .env.local` |
| BigQuery cleanup fails | Missing GCP auth | Run `gcloud auth login` |
| Pipeline fails | Procedures not synced | Script auto-syncs procedures |

## File Structure

```
tests/demo-setup/
├── config.ts                      # Shared configuration
├── setup-demo-account.ts          # Playwright automation (Steps 1-7)
├── load-demo-data-direct.ts       # Data loading + pipelines
├── cleanup-demo-account.ts        # Delete demo account
├── insert-demo-api-key.ts         # [DEPRECATED] API key is auto-created
├── add-demo-org-members.ts        # Add users to demo org
├── setup-demo-account.test.ts     # Vitest wrapper
├── run-setup.sh                   # Shell wrapper
└── README.md                      # This documentation
```

## Data Files

Demo data is located in: `04-inra-cicd-automation/load-demo-data/data/`

| Category | Files | Records |
|----------|-------|---------|
| GenAI | `genai/*.json` | ~4,000 |
| Cloud | `cloud/*.json` | ~12,000 |
| Subscriptions | `subscriptions/*.csv` | 15 plans |
| Pricing | `pricing/*.csv` | Reference data |

---
**Last Updated:** 2026-01-03
